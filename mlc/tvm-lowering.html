
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="tvm-tensorIR.html">
      
      
        <link rel="next" href="tvm-autotvm.html">
      
      <link rel="icon" href="../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.11">
    
    
      
        <title>tvm-lowering - Cat538's Blog</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.85bb2934.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a6bdf11c.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tvm-lowering" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="Cat538&#39;s Blog" class="md-header__button md-logo" aria-label="Cat538's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cat538's Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              tvm-lowering
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Cat538&#39;s Blog" class="md-nav__button md-logo" aria-label="Cat538's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Cat538's Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Prologue
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../plan.html" class="md-nav__link">
        Exercise
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Cpp
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Cpp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cpp/toolchain.html" class="md-nav__link">
        toolchain
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cpp/move.html" class="md-nav__link">
        move
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cpp/align.html" class="md-nav__link">
        align
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cpp/ranges.html" class="md-nav__link">
        ranges
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cpp/benchmark.html" class="md-nav__link">
        benchmark
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cpp/profiler.html" class="md-nav__link">
        profiler
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cpp/IO-multiplexing.html" class="md-nav__link">
        IO-multiplexing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cpp/epoll.html" class="md-nav__link">
        epoll
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cpp/signal.html" class="md-nav__link">
        signal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cpp/fork-safe.html" class="md-nav__link">
        fork-safe
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Rust
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Rust
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rust/rust-toolchain.html" class="md-nav__link">
        rust-toolchain
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rust/rust-study.html" class="md-nav__link">
        rust-study
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rust/rust-attributes.html" class="md-nav__link">
        rust-attributes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rust/rust-modules.html" class="md-nav__link">
        rust-modules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rust/rust-macro.html" class="md-nav__link">
        rust-macro
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rust/rust-network.html" class="md-nav__link">
        rust-network
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rust/rust-option.html" class="md-nav__link">
        rust-optin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rust/rust-str.html" class="md-nav__link">
        rust-str
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/cmake.html" class="md-nav__link">
        cmake
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/docker.html" class="md-nav__link">
        docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/git.html" class="md-nav__link">
        git
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/powershell.html" class="md-nav__link">
        powershell
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/regex.html" class="md-nav__link">
        regex
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/mkdocs.html" class="md-nav__link">
        mkdocs
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Courses
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Courses
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../courses/%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90%E5%AD%A6%E5%A4%8D%E4%B9%A0.html" class="md-nav__link">
        å¯†ç åˆ†æå­¦
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../courses/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%BC%95%E8%AE%BA%E5%A4%8D%E4%B9%A0.html" class="md-nav__link">
        å¯†ç å­¦å¼•è®º
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../courses/algorithm.html" class="md-nav__link">
        ç®—æ³•è®¾è®¡ä¸åˆ†æ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../courses/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86.html" class="md-nav__link">
        ç¼–è¯‘åŸç†
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          Crypto
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Crypto
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../crypto/ecdsa-pk-recovery.html" class="md-nav__link">
        ecdsa-pk-recovery
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../crypto/algo-rsa.html" class="md-nav__link">
        algo-rsa
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../crypto/algo-fft%26ntt.html" class="md-nav__link">
        algo-fft&ntt
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../crypto/algo-reduction.html" class="md-nav__link">
        algo-reduction
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          Mlc
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Mlc
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="dlc-survey.html" class="md-nav__link">
        dlc-survey
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="tvm-install.html" class="md-nav__link">
        tvm-install
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="tvm-ffi.html" class="md-nav__link">
        tvm-ffi
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="tvm-type.html" class="md-nav__link">
        tvm-type
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="tvm-tensorIR.html" class="md-nav__link">
        tvm-tensorIR
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          tvm-lowering
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="tvm-lowering.html" class="md-nav__link md-nav__link--active">
        tvm-lowering
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-lower-tir" class="md-nav__link">
    1. Lower Tir
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-lower-te" class="md-nav__link">
    2. Lower TE
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-lower-relay" class="md-nav__link">
    3. Lower Relay
  </a>
  
    <nav class="md-nav" aria-label="3. Lower Relay">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-topi" class="md-nav__link">
    3.1. TOPI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-relay-graphexecutor" class="md-nav__link">
    3.2. Relay-GraphExecutor
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-lower-relax" class="md-nav__link">
    4. Lower Relax
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="tvm-autotvm.html" class="md-nav__link">
        tvm-autotvm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="tvm-ansor.html" class="md-nav__link">
        tvm-ansor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="mlir.html" class="md-nav__link">
        mlir
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="mlir-toy.html" class="md-nav__link">
        mlir-toy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="mlir-onnx.html" class="md-nav__link">
        mlir-onnx
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="mlir-iree.html" class="md-nav__link">
        mlir-iree
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="paper-torch.fx.html" class="md-nav__link">
        paper-torch.fx
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="paper-nimble.html" class="md-nav__link">
        paper-nimble
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="paper-disc.html" class="md-nav__link">
        paper-disc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="paper-cortex.html" class="md-nav__link">
        paper-cortex
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="paper-freetensor.html" class="md-nav__link">
        paper-freetensor
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../about.html" class="md-nav__link">
        About
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-lower-tir" class="md-nav__link">
    1. Lower Tir
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-lower-te" class="md-nav__link">
    2. Lower TE
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-lower-relay" class="md-nav__link">
    3. Lower Relay
  </a>
  
    <nav class="md-nav" aria-label="3. Lower Relay">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-topi" class="md-nav__link">
    3.1. TOPI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-relay-graphexecutor" class="md-nav__link">
    3.2. Relay-GraphExecutor
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-lower-relax" class="md-nav__link">
    4. Lower Relax
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="tvm-lowering">TVM-lowering</h1>
<blockquote>
<p>Ref:</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/533161438">TVM è‡ªåº•å‘ä¸Šï¼ˆäºŒï¼‰ï¼šTIR çš„æ¦‚å¿µå’Œç¼–è¯‘åŸç†</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzA4MjY4NTk0NQ==&amp;mid=2247494373&amp;idx=1&amp;sn=6eb14998e8cfe45a144ba1b8c61346ac&amp;chksm=9f835073a8f4d96555ed6382f25d8b5793e7b56da0f403867b7a38c48bbeedc23701c2e59721&amp;scene=178&amp;cur_album_id=1799364124980609027#rd">ã€ä»é›¶å¼€å§‹å­¦æ·±åº¦å­¦ä¹ ç¼–è¯‘å™¨ã€‘å››ï¼Œè§£æTVMç®—å­</a></li>
<li><a href="http://giantpandacv.com/project/%E9%83%A8%E7%BD%B2%E4%BC%98%E5%8C%96/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%BC%96%E8%AF%91%E5%99%A8/%E3%80%90%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%91%E5%85%AD%EF%BC%8CTVM%E7%9A%84%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3/">ã€ä»é›¶å¼€å§‹å­¦æ·±åº¦å­¦ä¹ ç¼–è¯‘å™¨ã€‘å…­ï¼ŒTVMçš„ç¼–è¯‘æµç¨‹è¯¦è§£</a></li>
<li><a href="https://mp.weixin.qq.com/s/NM5yvxW2JSbR06RmrR3ubw">TVM å­¦ä¹ æŒ‡å—ï¼ˆä¸ªäººç‰ˆï¼‰</a></li>
</ul>
</blockquote>
<h2 id="1-lower-tir">1. Lower Tir</h2>
<blockquote>
<p>TIRä¸€èˆ¬è®¤ä¸ºæ˜¯ target irï¼ŒTensorIRæ˜¯åé¢åˆæçš„æ–°æ¦‚å¿µï¼Œåšä¸ºtvm scriptçš„ä¸€éƒ¨åˆ†ã€‚</p>
</blockquote>
<p>è¿™èŠ‚ç”¨ä¸€ä¸ªä¾‹å­è¿½è¸ª tir è¡¨ç¤ºçš„ PrimFunc æ˜¯å¦‚ä½•ç»è¿‡ target translation è¢«ç¿»è¯‘ä¸ºç‰¹å®štargetçš„ä¸€ä¸ª <code>runtime.Module</code></p>
<p>ä½¿ç”¨çš„ä¾‹å­ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">tvm</span>
<span class="kn">from</span> <span class="nn">tvm</span> <span class="kn">import</span> <span class="n">te</span>
<span class="n">SIZE</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="c1"># 1. ä½¿ç”¨ TE å£°æ˜è®¡ç®—</span>
<span class="c1"># mm</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">reduce_axis</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">),</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">placeholder</span><span class="p">((</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">placeholder</span><span class="p">((</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">compute</span><span class="p">((</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">te</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">k</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MM&#39;</span><span class="p">)</span>
<span class="c1"># relu</span>
<span class="n">D_IN</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">placeholder</span><span class="p">((</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;RELU_IN&#39;</span><span class="p">)</span>
<span class="n">D_OUT</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">compute</span><span class="p">((</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="n">te</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">D_IN</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;RELU_OUT&quot;</span><span class="p">)</span>

<span class="c1"># 2. ä» TE åˆ›å»º PrimFunc </span>
<span class="n">te_mm</span><span class="p">:</span> <span class="n">tvm</span><span class="o">.</span><span class="n">tir</span><span class="o">.</span><span class="n">PrimFunc</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">create_prim_func</span><span class="p">([</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">])</span><span class="o">.</span><span class="n">with_attr</span><span class="p">({</span><span class="s2">&quot;global_symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;mmult&quot;</span><span class="p">})</span>
<span class="n">te_relu</span><span class="p">:</span> <span class="n">tvm</span><span class="o">.</span><span class="n">tir</span><span class="o">.</span><span class="n">PrimFunc</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">create_prim_func</span><span class="p">([</span><span class="n">D_IN</span><span class="p">,</span> <span class="n">D_OUT</span><span class="p">])</span><span class="o">.</span><span class="n">with_attr</span><span class="p">({</span><span class="s2">&quot;global_symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;relu&quot;</span><span class="p">})</span>

<span class="c1"># 3. å°†åˆ›å»ºå‡ºæ¥çš„ PrimFunc æ·»åŠ åˆ°ä¸€ä¸ª IRModule ä¸­</span>
<span class="n">ir_m</span><span class="p">:</span> <span class="n">tvm</span><span class="o">.</span><span class="n">IRModule</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">IRModule</span><span class="p">({</span><span class="s1">&#39;mm&#39;</span><span class="p">:</span> <span class="n">te_mm</span><span class="p">})</span>
<span class="n">gv_relu</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">ir</span><span class="o">.</span><span class="n">GlobalVar</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">)</span>
<span class="n">ir_m</span><span class="o">.</span><span class="n">update_func</span><span class="p">(</span><span class="n">gv_relu</span><span class="p">,</span> <span class="n">te_relu</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ir_m</span><span class="o">.</span><span class="n">get_global_vars</span><span class="p">())</span>
<span class="c1"># è¿™é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨ å…ˆæ„å»º Scheduleï¼Œ å†è°ƒç”¨ `tvm.lower` çš„æ–¹æ³• å¾—åˆ°ä¸€ä¸ª IRModule</span>
<span class="c1"># te_sch: te.Schedule = te.create_schedule(C.op) # C.op: te.tensor.ComputeOp</span>
<span class="c1"># ir_m: tvm.IRModule = tvm.lower(te_sch, [A, B, C], simple_mode=True,name=&#39;mmult&#39;)</span>

<span class="c1"># 4. Lower and Build</span>
<span class="sd">&#39;&#39;&#39; åœ¨è¿™ä¸€æ­¥å°† IRModule ==&gt; runtime.Module&#39;&#39;&#39;</span>
<span class="n">rt_m</span><span class="p">:</span> <span class="n">tvm</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">ir_m</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;llvm&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;func_set&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[31mtvm.build</span><span class="se">\033</span><span class="s2">[0m: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ir_m</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="se">\033</span><span class="s2">[31m==&gt;</span><span class="se">\033</span><span class="s2">[0m </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">rt_m</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># print IRModuleï¼Œ å…¶ä¸­åŒ…å«ä¸€ä¸ª PrimFunc</span>
<span class="c1"># print(f&quot;\033[31mAfter lowering, the IRModule\033[0m:\n{ir_m}&quot;)</span>
<span class="n">ir_m</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># # print source code</span>
<span class="c1"># print(f&quot;\033[31msource code\033[0m:\n{rt_m.get_source()}&quot;)</span>
</code></pre></div>
<p><code>tvm.build</code> å°†ä»£ç ä» IRModule è½¬æ¢æˆ runtime.Moduleï¼› </p>
<ul>
<li>å…¶ä¸­ IRModule å®šä¹‰åœ¨ <code>include/tvm/ir/module.h</code> ä¸­ï¼› å¯ä»¥ç®€å•è§†ä½œä¸€ä¸ª <code>&lt;name, BaseFunc&gt;</code> çš„å“ˆå¸Œè¡¨(å³å¯åŒæ—¶åŒ…å«<code>PrimFunc</code> å’Œ <code>Func</code>)</li>
<li>å…¶ä¸­ runtime.Module å®šä¹‰å¯¹åº”åœ¨ <code>include/tvm/runtime/module.h</code> ä¸­ï¼› å¯ä»¥ç®€å•è§†ä½œä¸€ä¸ª <code>&lt;name, PackedFunc&gt;</code> çš„å“ˆå¸Œè¡¨ã€‚ <code>ModuleNode</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œ å¯¹åº”æœ‰å¤šç§ä¸åŒçš„å®ç°ï¼Œ å¦‚ <code>CUDAModuleNode</code>ï¼Œ <code>LLVMModuleNode</code> ç­‰</li>
</ul>
<p>ä»¥ä½¿ç”¨teå£°æ˜ è®¡ç®—è¿‡ç¨‹ ä¸ºä¾‹ï¼Œå±•ç¤ºä¸€ä¸ª <code>te.tensor.ComputeOp</code> æ˜¯å¦‚ä½•è¢«ç¼–è¯‘æˆ <code>runtime.Module</code> çš„ï¼š</p>
<ol>
<li>ä½¿ç”¨teå£°æ˜è®¡ç®—è¿‡ç¨‹</li>
<li>
<p>ä½¿ç”¨ <code>te.create_schedule</code> åˆ›å»ºä¸€ä¸ªSchedule å¯¹è±¡ï¼Œ æ¥ç€ä½¿ç”¨ <code>te.lower()</code> å°†ä¸€ä¸ª <code>te.Schedule</code> è½¬æˆä¸€ä¸ªIRModuleï¼›</p>
<p>æˆ–è€…ä½¿ç”¨ <code>te.create_prim_func</code> åˆ›å»ºä¸€ä¸ª <code>tvm.tir.PrimFunc</code> å¯¹è±¡(å³ MLC è¯¾ç¨‹ ä¸­æ‰€è¯´çš„ä¸€ä¸ª<strong>å…ƒå¼ é‡å‡½æ•°</strong>)ï¼Œ ç„¶åä½¿ç”¨ IRModule çš„æ„é€ å‡½æ•°æŠŠè¿™ä¸ª PrimFunc æ”¾åˆ°IRModule ä¸­</p>
</li>
<li>
<p>æ¥ç€è°ƒç”¨ <code>tvm.build()</code> å¯¹ IRModuleè¿›è¡Œæ„å»ºï¼š åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œ IRModule æœ€ç»ˆå°†è¢«è½¬æ¢æˆä¸€ä¸ª <code>runtime.Module</code>ï¼› </p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ <code>tvm.build</code> å¯ä»¥æ¥å— <code>Schedule</code>, <code>PrimFunc</code>, <code>IRModule</code> ç­‰å¤šç§ç±»å‹ï¼ˆå®é™…ä¸Šéƒ½ä¼šè¢«è½¬æˆ IRModule ç„¶åå†ç¼–è¯‘ï¼‰ä½œä¸ºè¾“å…¥ï¼Œ å¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ª <code>Schedule</code> çš„è¯ï¼Œ åˆ™éœ€è¦ä¼ å…¥å‡½æ•°ç›¸åº”çš„è¾“å…¥å‚æ•°åˆ—è¡¨</p>
</li>
</ol>
<p>ğŸ’¡<strong>å› æ­¤æ¥ä¸‹æ¥ä¸»è¦çœ‹ ä½äº <code>python/driver/build_module.py</code> ä¸­çš„ <code>tvm.build</code> æ–¹æ³•</strong></p>
<hr />
<p><code>tvm.build()</code> åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªä¸»è¦æ­¥éª¤</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">build</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">te</span><span class="o">.</span><span class="n">Schedule</span><span class="p">,</span> <span class="n">PrimFunc</span><span class="p">,</span> <span class="n">IRModule</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">IRModule</span><span class="p">]],</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Buffer</span><span class="p">,</span> <span class="n">tensor</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Var</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Target</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">target_host</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Target</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">runtime</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;tvm.relay.backend.Runtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default_function&quot;</span><span class="p">,</span>
    <span class="n">binds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="n">tensor</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">tvm</span><span class="o">.</span><span class="n">IRModule</span><span class="p">):</span>
      <span class="n">input_mod</span> <span class="o">=</span> <span class="n">lower</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">container</span><span class="o">.</span><span class="n">Map</span><span class="p">)):</span>
      <span class="n">target</span> <span class="o">=</span> <span class="n">Target</span><span class="o">.</span><span class="n">current</span><span class="p">()</span> <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">target</span>
      <span class="n">target</span> <span class="o">=</span> <span class="n">target</span> <span class="k">if</span> <span class="n">target</span> <span class="k">else</span> <span class="s2">&quot;llvm&quot;</span>
      <span class="n">target_input_mod</span> <span class="o">=</span> <span class="p">{</span><span class="n">target</span><span class="p">:</span> <span class="n">input_mod</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">target_input_mod</span> <span class="o">=</span> <span class="n">inputs</span>

    <span class="n">annotated_mods</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">tar</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">target_input_mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">annotated_mods</span><span class="p">[</span><span class="n">tar</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">with_attr</span><span class="p">(</span><span class="s2">&quot;runtime&quot;</span><span class="p">,</span> <span class="n">runtime</span><span class="p">)</span>

    <span class="c1"># çœç•¥ get target_host çš„ä»£ç </span>
    <span class="n">target_host</span> <span class="o">=</span> <span class="s2">&quot;llvm&quot;</span>

    <span class="n">annotated_mods</span><span class="p">,</span> <span class="n">target_host</span> <span class="o">=</span> <span class="n">Target</span><span class="o">.</span><span class="n">canon_target_map_and_host</span><span class="p">(</span><span class="n">annotated_mods</span><span class="p">,</span> <span class="n">target_host</span><span class="p">)</span>
    <span class="n">rt_mod_host</span> <span class="o">=</span> <span class="n">_driver_ffi</span><span class="o">.</span><span class="n">tir_to_runtime</span><span class="p">(</span><span class="n">annotated_mods</span><span class="p">,</span> <span class="n">target_host</span><span class="p">)</span>
    <span class="n">annotated_mods</span><span class="p">,</span> <span class="n">target_host</span> <span class="o">=</span> <span class="n">Target</span><span class="o">.</span><span class="n">canon_target_map_and_host</span><span class="p">(</span><span class="n">annotated_mods</span><span class="p">,</span> <span class="n">target_host</span><span class="p">)</span>

    <span class="n">to_return</span> <span class="o">=</span> <span class="n">rt_mod_host</span>
    <span class="k">return</span> <span class="n">OperatorModule</span><span class="o">.</span><span class="n">from_module</span><span class="p">(</span><span class="n">to_return</span><span class="p">,</span> <span class="n">ir_module_by_target</span><span class="o">=</span><span class="n">annotated_mods</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
<ol>
<li>
<p>è°ƒç”¨ <code>python/driver/build_module.py</code> ä¸­ <code>lower()</code>ï¼Œ è¿™æ˜¯ä¸€æ­¥ä½œç”¨æ˜¯æ‰§è¡Œ IRModuleï¼ˆor scheduleç­‰ï¼‰ åˆ° IRModule çš„å˜æ¢ï¼Œæ‰§è¡Œ tir å±‚çº§çš„ target æ— å…³ä¼˜åŒ–ã€‚ å…·ä½“æ¥è¯´ï¼Œ<code>lower()</code> ä¸­ä¼šè°ƒç”¨ <code>ffi.lower_module(inp, simple_mode)</code>ï¼Œè¿™é‡Œå¯¹åº”åˆ° C++ ä»£ç  <code>src/dirver/driver_api.cc</code> ä¸­çš„ <code>LowerModule</code> æ–¹æ³•ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">IRModule</span><span class="w"> </span><span class="nf">LowerModule</span><span class="p">(</span><span class="n">IRModule</span><span class="w"> </span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">simple_mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">transform</span><span class="o">::</span><span class="n">Pass</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pass_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreatePassList</span><span class="p">(</span><span class="n">simple_mode</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">LowerWithPassList</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">mod</span><span class="p">),</span><span class="w"> </span><span class="n">pass_list</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">TVM_REGISTER_GLOBAL</span><span class="p">(</span><span class="s">&quot;driver.lower_module&quot;</span><span class="p">).</span><span class="n">set_body_typed</span><span class="p">([](</span><span class="n">IRModule</span><span class="w"> </span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">simple_mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">LowerModule</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">mod</span><span class="p">),</span><span class="w"> </span><span class="n">simple_mode</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>å¯ä»¥çœ‹åˆ° åœ¨ <code>LowerModule</code> é€»è¾‘ä¸­ï¼Œ é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªpass åˆ—è¡¨ï¼Œ åŒ…å«äº†<code>tir::transform</code>ä¸­çš„ä¸€äº›å˜æ¢ï¼Œ ç„¶åè°ƒç”¨ <code>LowerWithPassList</code> æŠŠåˆ—è¡¨ä¸­çš„ pass åº”ç”¨åˆ°è¯¥ IRModule ä¸­ï¼šå³é¦–å…ˆå°† <code>pass_list</code> æ„é€ æˆä¸€ä¸ª <code>Sequential</code> å¯¹è±¡ï¼Œ ç„¶åè°ƒç”¨ <code>SequentialNode::operator()</code> ï¼Œ </p>
</li>
<li>
<p>åœ¨ç¬¬ä¸€æ­¥çš„ lowering ä¹‹åï¼Œ<code>tvm.build()</code> æ¥æ”¶çš„inputså‚æ•° <code>Union[te.Schedule, PrimFunc, IRModule, Mapping[str, IRModule]]</code> è¢«è½¬æˆäº†ä¸€ä¸ª ç»è¿‡åˆæ­¥ä¼˜åŒ–çš„ IRModule ï¼Œ å¹¶æ‰§è¡Œäº† tir çº§åˆ«çš„ target independent ä¼˜åŒ–ã€‚ <strong>æ¥ä¸‹æ¥å°±æ˜¯æ‰§è¡Œä»£ç ç”Ÿæˆçš„å·¥ä½œ</strong>ï¼Œ é¦–å…ˆæ£€æŸ¥ target ç›¸å…³ä¿¡æ¯ï¼Œä¼šæ ¹æ® <code>tvm.build()</code> çš„è¾“å…¥è®¾ç½®ç›¸åº”çš„ target, target_host ç­‰å˜é‡</p>
</li>
<li>
<p>åœ¨æ‹¿åˆ° target ç­‰è§„èŒƒæ ¼å¼çš„ä¿¡æ¯ä¹‹åï¼Œä¼šæ‰§è¡Œ<code>rt_mod_host = _driver_ffi.tir_to_runtime(annotated_mods, target_host)</code> ï¼Œè¿™é‡Œè°ƒç”¨çš„ <code>tir_to_runtime</code> å¯¹åº”åˆ°C++ä¸­çš„ <code>TIRToRuntime</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">TVM_REGISTER_GLOBAL</span><span class="p">(</span><span class="s">&quot;driver.tir_to_runtime&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">set_body_typed</span><span class="p">([](</span><span class="k">const</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Target</span><span class="p">,</span><span class="w"> </span><span class="n">IRModule</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">inputs_arg</span><span class="p">,</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="n">host_target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TIRToRuntime</span><span class="p">(</span><span class="n">inputs_arg</span><span class="p">,</span><span class="w"> </span><span class="n">host_target</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
</code></pre></div>
<p>æ¯”è¾ƒå…³é”®çš„ <code>TIRToRuntime</code> é€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">runtime</span><span class="o">::</span><span class="n">Module</span><span class="w"> </span><span class="nf">TIRToRuntime</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Target</span><span class="p">,</span><span class="w"> </span><span class="n">IRModule</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">inputs_arg</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Target</span><span class="o">&amp;</span><span class="w"> </span><span class="n">target_host_arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">runtime</span><span class="o">::</span><span class="n">Module</span><span class="o">&gt;</span><span class="w"> </span><span class="n">device_modules</span><span class="p">;</span>
<span class="w">  </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Target</span><span class="p">,</span><span class="w"> </span><span class="n">IRModule</span><span class="o">&gt;</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputs_arg</span><span class="p">;</span>
<span class="w">  </span><span class="n">Target</span><span class="w"> </span><span class="n">target_host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target_host_arg</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// 1. æ£€æŸ¥å¹¶è®¾ç½®target_host</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="w">  </span><span class="c1">// 2. éå†è¾“å…¥çš„ {Target: IRModule}</span>
<span class="w">  </span><span class="c1">//  SplitMixedModule å°†ä¸€ä¸ª IRModule åˆ†ä¸º host ä¸ device ä¸¤éƒ¨åˆ†</span>
<span class="w">  </span><span class="c1">//  æ ¹æ® host ä¸ device ä¿¡æ¯æ›´æ–° mhost_all</span>
<span class="w">  </span><span class="n">IRModule</span><span class="w"> </span><span class="n">mhost_all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IRModule</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">GlobalVar</span><span class="p">,</span><span class="w"> </span><span class="n">BaseFunc</span><span class="o">&gt;</span><span class="p">(),{},{},{},(</span><span class="o">*</span><span class="n">inputs</span><span class="p">.</span><span class="n">begin</span><span class="p">()).</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">inputs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">defined</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">ir_module</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="p">;</span>
<span class="w">      </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">host_mod</span><span class="p">,</span><span class="w"> </span><span class="n">device_mod</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SplitMixedModule</span><span class="p">(</span><span class="n">ir_module</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">target_host</span><span class="p">);</span>

<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">overrides_host_target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">GetTargetDeviceType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">target_host</span><span class="o">-&gt;</span><span class="n">GetTargetDeviceType</span><span class="p">();</span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">non_host_target_kind</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">kind</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">target_host</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overrides_host_target</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">non_host_target_kind</span><span class="p">)</span>
<span class="w">        </span><span class="n">device_modules</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">codegen</span><span class="o">::</span><span class="n">Build</span><span class="p">(</span><span class="n">host_mod</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">));</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="n">mhost_all</span><span class="o">-&gt;</span><span class="n">Update</span><span class="p">(</span><span class="n">host_mod</span><span class="p">);</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device_mod</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="n">device_modules</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">codegen</span><span class="o">::</span><span class="n">Build</span><span class="p">(</span><span class="n">device_mod</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 3. Build host module</span>
<span class="w">  </span><span class="n">runtime</span><span class="o">::</span><span class="n">Module</span><span class="w"> </span><span class="n">mhost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">codegen</span><span class="o">::</span><span class="n">Build</span><span class="p">(</span><span class="n">mhost_all</span><span class="p">,</span><span class="w"> </span><span class="n">target_host</span><span class="p">);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">device_modules</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="k">operator</span><span class="o">-&gt;</span><span class="p">())</span>
<span class="w">      </span><span class="n">mhost</span><span class="p">.</span><span class="n">Import</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">mhost</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>è¿™é‡Œæ¯”è¾ƒå…³é”®çš„ <code>codegen::build</code> åœ¨<code>src/target/codegen.cc</code> ä¸­ï¼Œ å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">runtime</span><span class="o">::</span><span class="n">Module</span><span class="w"> </span><span class="nf">Build</span><span class="p">(</span><span class="n">IRModule</span><span class="w"> </span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">target_attr_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tvm</span><span class="o">::</span><span class="n">TargetKind</span><span class="o">::</span><span class="n">GetAttrMap</span><span class="o">&lt;</span><span class="n">FTVMTIRToRuntime</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;TIRToRuntime&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">target_attr_map</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">))</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">target_attr_map</span><span class="p">[</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">](</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">build_f_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;target.build.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">kind</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">PackedFunc</span><span class="o">*</span><span class="w"> </span><span class="n">bf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runtime</span><span class="o">::</span><span class="n">Registry</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="n">build_f_name</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">bf</span><span class="p">)(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>å¯ä»¥çœ‹åˆ° é€šè¿‡ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ æ‹¿åˆ° <code>build_f_name</code> (ä¾‹å¦‚ target æ˜¯ llvmï¼Œ è¿™é‡Œå¾—åˆ°å°±æ˜¯ "target.build.llvm"ï¼Œ cuda å°±æ˜¯ "target.build.cuda")ï¼Œ æ¥ç€ç”¨è¿™ä¸ªåå­—æŸ¥æ‰¾åˆ°å·²æ³¨å†Œçš„å‡½æ•°ï¼Œè¿›è¡Œ build</p>
</li>
<li>
<p>æ¥ä¸‹æ¥åˆ†åˆ«ä»¥ llvm åç«¯ï¼ˆä¸è®¾ç½®runtimeï¼‰ å’Œ cuda åç«¯ä¸ºä¾‹ çœ‹ä¸€ä¸‹å¦‚ä½•ç”Ÿæˆçš„ llvm IR or CUDA ä»£ç </p>
<div class="highlight"><pre><span></span><code><span class="c1">// `src/target/llvm/llvm_module.cc`</span>
<span class="n">TVM_REGISTER_GLOBAL</span><span class="p">(</span><span class="s">&quot;target.build.llvm&quot;</span><span class="p">)</span>
<span class="p">.</span><span class="n">set_body_typed</span><span class="p">([](</span><span class="n">IRModule</span><span class="w"> </span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">runtime</span><span class="o">::</span><span class="n">Module</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_object</span><span class="o">&lt;</span><span class="n">LLVMModuleNode</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">  </span><span class="n">n</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">runtime</span><span class="o">::</span><span class="n">Module</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">// `src/target/opt/build_cuda_on.cc`</span>
<span class="n">TVM_REGISTER_GLOBAL</span><span class="p">(</span><span class="s">&quot;target.build.cuda&quot;</span><span class="p">).</span><span class="n">set_body_typed</span><span class="p">(</span><span class="n">BuildCUDA</span><span class="p">);</span>
</code></pre></div>
<p>é¦–å…ˆçœ‹CUDAçš„ tir =&gt; bin ç¼–è¯‘æµç¨‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">runtime</span><span class="o">::</span><span class="n">Module</span><span class="w"> </span><span class="nf">BuildCUDA</span><span class="p">(</span><span class="n">IRModule</span><span class="w"> </span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Step 1: Initialize CodeGen for CUDA  </span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">output_ssa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">  </span><span class="n">CodeGenCUDA</span><span class="w"> </span><span class="n">cg</span><span class="p">;</span>
<span class="w">  </span><span class="n">cg</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">output_ssa</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Step 2: Add all tir::PrimFunc in IRModule to compile list</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">kv</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Downcast</span><span class="o">&lt;</span><span class="n">PrimFunc</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kv</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<span class="w">    </span><span class="n">cg</span><span class="p">.</span><span class="n">AddFunction</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Step 3: Lower IRModule to CUDA source code</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="p">.</span><span class="n">Finish</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Step 4: Compile CUDA source code using NVCC and create runtime::Module</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">fmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ptx&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">ptx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NVRTCCompile</span><span class="p">(</span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">cg</span><span class="p">.</span><span class="n">need_include_path</span><span class="p">());</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">CUDAModuleCreate</span><span class="p">(</span><span class="n">ptx</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="p">,</span><span class="w"> </span><span class="n">ExtractFuncInfo</span><span class="p">(</span><span class="n">mod</span><span class="p">),</span><span class="w"> </span><span class="n">code</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>å¹¶è¡Œçº¿ç¨‹æ‰§è¡Œï¼ˆParallel Thread eXecutionï¼ŒPTXï¼‰ä»£ç æ˜¯ç¼–è¯‘åçš„GPUä»£ç çš„ä¸€ç§ IR ï¼Œ å®ƒå¯ä»¥å†æ¬¡ç¼–è¯‘ä¸ºåŸç”Ÿçš„GPUæŒ‡ä»¤</strong>ã€‚PTXæä¾›äº†ä¸€ä¸ªç¨³å®šçš„ç¼–ç¨‹æ¨¡å‹å’ŒæŒ‡ä»¤é›†ï¼Œè¿™ä¸ªISAèƒ½å¤Ÿè·¨è¶Šå¤šç§GPUï¼Œå¹¶ä¸”èƒ½å¤Ÿä¼˜åŒ–ä»£ç çš„ç¼–è¯‘ç­‰ç­‰ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹ LLVMï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœ target="llvm"ï¼Œç”±äº LLVM IR ä»ç„¶åªæ˜¯ä¸€ç§ä¸­é—´è¡¨ç¤ºï¼Œè¿˜éœ€è¦æ ¹æ® target å½“ä¸­æ›´è¯¦ç»†çš„ç¡¬ä»¶å‚æ•°ï¼Œæ‰¾åˆ°ç›®æ ‡ç¼–è¯‘ç¡¬ä»¶ï¼Œç„¶åè°ƒç”¨ç›¸åº”çš„ CodeGenï¼ˆçœç•¥éƒ¨åˆ†è¾…åŠ©ä»£ç ï¼‰ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">IRModule</span><span class="o">&amp;</span><span class="w"> </span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Target</span><span class="o">&amp;</span><span class="w"> </span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Step 1: Initialize CodeGen for LLVM with different target</span>
<span class="w">  </span><span class="n">InitializeLLVM</span><span class="p">();</span>
<span class="w">  </span><span class="n">tm_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetLLVMTargetMachine</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">CodeGenLLVM</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CodeGenLLVM</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">tm_</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>

<span class="w">  </span><span class="c1">// Step 2: Add all tir::PrimFunc in IRModule to compile list</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PrimFunc</span><span class="o">&gt;</span><span class="w"> </span><span class="n">funcs</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">kv</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">kv</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">IsInstance</span><span class="o">&lt;</span><span class="n">PrimFuncNode</span><span class="o">&gt;</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// (@jroesch): we relax constraints here, Relay functions will just be ignored.</span>
<span class="w">      </span><span class="n">DLOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Can only lower IR Module with PrimFuncs, but got &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">kv</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">GetTypeKey</span><span class="p">();</span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Downcast</span><span class="o">&lt;</span><span class="n">PrimFunc</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kv</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<span class="w">    </span><span class="n">funcs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Step 3: Lower IRModule to LLVM IR code</span>
<span class="w">  </span><span class="n">module_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="o">-&gt;</span><span class="n">Finish</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæ„é€ äº†ä¸€ä¸ª <code>LLVMModuleNode</code> å®ä¾‹ï¼Œ è°ƒç”¨äº†å®ƒçš„ <code>Init</code> æ–¹æ³•ï¼Œ å› æ­¤å¯çŸ¥è¯¥æ–¹æ³•å°±æ˜¯å°† IRModule lower ä¸º LLVMModuleNode çš„æ ¸å¿ƒå‡½æ•°ã€‚ å…³äº <code>LLVMModuleNode</code> çš„å®šä¹‰ï¼Œ å¯å‚è€ƒ <a href="tvm-type.html">TVM-type</a>ï¼Œä¸‹é¢æ˜¯ <code>Init</code> æ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p>
</li>
<li>
<p>ä»ä¸Šä¸€æ­¥ä¸­å¯çŸ¥ï¼Œ TIR èƒ½ lower æˆç›®æ ‡æºä»£ç ï¼Œå…³é”®æ˜¯ CodeGenã€‚ä¸Šé¢æåˆ°çš„ CodeGenCUDAï¼Œä»¥åŠ CodeGenLLVM æ˜¯å®Œæˆ TIR lower ä¸º C++ ä»£ç çš„ç›¸å…³ç»“æ„ã€‚ å…¶ä¸­ <code>CodeGenCUDA</code>ç»§æ‰¿è‡ª <code>CodeGenC</code>ï¼Œä»¥å…¶ä¸ºä¾‹å­è¯´æ˜ï¼ˆ<code>tvm/src/target/source/codegen_c.[h, cc]</code>ï¼‰ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CodeGenC</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ExprFunctor</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">PrimExpr</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">             </span><span class="k">public</span><span class="w"> </span><span class="n">StmtFunctor</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Stmt</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">             </span><span class="k">public</span><span class="w"> </span><span class="n">CodeGenSourceBase</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="c1">// expression</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">VisitExpr_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VarNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span><span class="w">         </span><span class="c1">// NOLINT(*)</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">VisitExpr_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">LoadNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span><span class="w">        </span><span class="c1">// NOLINT(*)</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">VisitExpr_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">BufferLoadNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span><span class="w">  </span><span class="c1">// NOLINT(*)</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">VisitExpr_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">LetNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span><span class="w">         </span><span class="c1">// NOLINT(*)</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="c1">// statment</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">VisitStmt_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">LetStmtNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">VisitStmt_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">StoreNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">VisitStmt_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">BufferStoreNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">VisitStmt_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ForNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">VisitStmt_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">WhileNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">VisitStmt_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">IfThenElseNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ <code>CodeGenC</code> ä¼šéå†åˆ°ä¸¤ç§ TIR Nodeï¼šExpressionï¼ˆè¡¨è¾¾å¼ï¼‰ å’Œ Statementï¼ˆè¯­å¥ï¼‰ã€‚Expressionï¼ˆè¡¨è¾¾å¼ï¼‰ä¸­åŒ…å«äº†å¸¸è§çš„å˜é‡å£°æ˜ã€è¿ç®—ã€åˆ¤æ–­ã€å‡½æ•°è°ƒç”¨ï¼Œè€Œ Statementï¼ˆè¯­å¥ï¼‰ä¸­åŒ…å«äº†æ§åˆ¶æµï¼ˆif-elseï¼ŒLoop ç­‰ï¼‰ã€å†…å­˜ç®¡ç†ã€èµ‹å€¼ç­‰æ“ä½œã€‚</p>
<p>ä¾‹å¦‚ï¼Œé‡åˆ°å››åˆ™è¿ç®—çš„ Expressionï¼ŒCodeGenC ç›´æ¥ç¿»è¯‘ä¸º " a OP b "çš„ä»£ç ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">PrintBinaryExpr</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">opstr</span><span class="p">,</span>
<span class="w">                            </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">,</span><span class="w"> </span><span class="n">CodeGenC</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// If both a and b are scalars</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dtype</span><span class="p">.</span><span class="n">lanes</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// If OP is an alphabet string, then lower it as &quot;OP(a, b)&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isalpha</span><span class="p">(</span><span class="n">opstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">opstr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39;(&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">PrintExpr</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">);</span>
<span class="w">      </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="p">;</span>
<span class="w">      </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">PrintExpr</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">);</span>
<span class="w">      </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39;)&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// If OP is a symbol, like + - * / %, then lower it as &quot;a OP b&quot;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39;(&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">PrintExpr</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">);</span>
<span class="w">      </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">opstr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">;</span>
<span class="w">      </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">PrintExpr</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">);</span>
<span class="w">      </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39;)&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// If both a and b are vectors</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">PrintVecBinaryOp</span><span class="p">(</span><span class="n">opstr</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dtype</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">CodeGenC</span><span class="o">::</span><span class="n">VisitExpr_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">AddNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// NOLINT(*)</span>
<span class="w">  </span><span class="n">PrintBinaryExpr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;+&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="n">CodeGenC</span><span class="o">::</span><span class="n">VisitExpr_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">SubNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// NOLINT(*)</span>
<span class="w">  </span><span class="n">PrintBinaryExpr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="n">CodeGenC</span><span class="o">::</span><span class="n">VisitExpr_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">MulNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// NOLINT(*)</span>
<span class="w">  </span><span class="n">PrintBinaryExpr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="n">CodeGenC</span><span class="o">::</span><span class="n">VisitExpr_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DivNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// NOLINT(*)</span>
<span class="w">  </span><span class="n">PrintBinaryExpr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>å¦‚æœé‡åˆ°é€‰æ‹© SelectNodeï¼ŒCodeGenC åˆ™ç¿»è¯‘ä¸º "(c ? a : b)" çš„ä»£ç ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">CodeGenC::VisitExpr_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">SelectNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">PrintExpr</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">condition</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">);</span>
<span class="w">  </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; ? &quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">PrintExpr</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">true_value</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">);</span>
<span class="w">  </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; : &quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">PrintExpr</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">false_value</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">);</span>
<span class="w">  </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ol>
<h2 id="2-lower-te">2. Lower TE</h2>
<p>ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬ä½¿ç”¨ TE(Tensor Expression) å£°æ˜è®¡ç®—è¿‡ç¨‹ï¼Œ æ„é€ äº†ä¸€ä¸ª PrimFuncã€‚ åœ¨TVM ä¸­ï¼Œ PrimFunc è¿˜å¯ä»¥é€šè¿‡ç¼–å†™ TVMScriptï¼Œ æˆ–è€…é€šè¿‡ relay/relax lower è€Œæ¥ã€‚ </p>
<p>TEæ˜¯ä½äº Relay IR / TOPI å’Œ TIR ä¹‹é—´æ¦‚å¿µï¼Œ æ˜¯TVM æä¾›çš„ä¸€ç§ç”¨äºç¼–å†™ Primfunc çš„ EDSLï¼Œ å…¶æŠ½è±¡ç¨‹åº¦æ¯” TIR æ›´é«˜ï¼Œæ— æ³•ç›´æ¥è¢«ç¼–è¯‘ä¸ºç¡¬ä»¶æºä»£ç ï¼Œå¿…é¡»å…ˆ lower ä¸º TIR çš„ Primitive Function å†è¿›è¡Œç¼–è¯‘ã€‚</p>
<p>åœ¨è¿™ä¸€èŠ‚ä¸­æˆ‘ä»¬å…³æ³¨ä½¿ç”¨ te æè¿°çš„è®¡ç®—è¿‡ç¨‹æ˜¯å¦‚ä½•è¢«è½¬æ¢æˆä¸€ä¸ª PrimFunc çš„ï¼Œå³å¯¹åº”åˆ° <a href="#1-lower-tir">Lower Tir</a> ä¸­æåˆ°çš„ <code>te.create_prim_func</code>ï¼Œ ä¹Ÿå°±æ˜¯å®˜æ–¹ç»™å‡ºçš„ ç¼–è¯‘æµç¨‹ä¸­çš„çº¢æ¡†ä¸­çš„éƒ¨åˆ†ï¼š</p>
<div class="autocb" style="text-align:center;"><img src="./tvm-lowering.assets\autocb_0.png" style="zoom: 50%;box-shadow: rgba(0, 0, 0, 0.5) 10px 10px 10px; border-radius: 10px;" /></div>

<p>æµ‹è¯•ä»£ç ä¸ç¬¬ä¸€èŠ‚ä¸­ä»£ç ç›¸åŒï¼Œåªä¸è¿‡æ­¤æ—¶æˆ‘ä»¬å…³æ³¨æ›´ä¸Šå±‚çš„éƒ¨åˆ†ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">tvm</span>
<span class="kn">from</span> <span class="nn">tvm</span> <span class="kn">import</span> <span class="n">te</span>
<span class="n">SIZE</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="c1"># 1. ä½¿ç”¨ TE å£°æ˜è®¡ç®—</span>
<span class="c1"># mm</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">placeholder</span><span class="p">((</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>  <span class="c1"># te.tensor.Tensor</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">placeholder</span><span class="p">((</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>  <span class="c1"># te.tensor.Tensor</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">reduce_axis</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">),</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>          <span class="c1"># tir.expr.IterVar</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">compute</span><span class="p">((</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">te</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">k</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MM&#39;</span><span class="p">)</span> <span class="c1"># te.tensor.Tensor</span>

<span class="c1"># 2. ä» TE åˆ›å»º PrimFunc </span>
<span class="n">te_mm</span><span class="p">:</span> <span class="n">tvm</span><span class="o">.</span><span class="n">tir</span><span class="o">.</span><span class="n">PrimFunc</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">create_prim_func</span><span class="p">([</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">])</span><span class="o">.</span><span class="n">with_attr</span><span class="p">({</span><span class="s2">&quot;global_symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;mmult&quot;</span><span class="p">})</span>

<span class="c1"># 3. å°†åˆ›å»ºå‡ºæ¥çš„ PrimFunc æ·»åŠ åˆ°ä¸€ä¸ª IRModule ä¸­</span>
<span class="n">ir_m</span><span class="p">:</span> <span class="n">tvm</span><span class="o">.</span><span class="n">IRModule</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">IRModule</span><span class="p">({</span><span class="s1">&#39;mm&#39;</span><span class="p">:</span> <span class="n">te_mm</span><span class="p">})</span>

<span class="c1"># è¿™é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨ å…ˆæ„å»º Scheduleï¼Œ å†è°ƒç”¨ `tvm.lower` çš„æ–¹æ³• å¾—åˆ°ä¸€ä¸ª IRModule</span>
<span class="n">te_sch</span><span class="p">:</span> <span class="n">te</span><span class="o">.</span><span class="n">Schedule</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">create_schedule</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">op</span><span class="p">)</span> <span class="c1"># C.op: te.tensor.ComputeOp</span>
<span class="n">ir_m</span><span class="p">:</span> <span class="n">tvm</span><span class="o">.</span><span class="n">IRModule</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">te_sch</span><span class="p">,</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">],</span> <span class="n">simple_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;mmult&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ir_m</span><span class="o">.</span><span class="n">get_global_vars</span><span class="p">())</span>
</code></pre></div>
<p>åœ¨å…³æ³¨ lowering ä¹‹å‰é¦–å…ˆçœ‹ä¸€ä¸‹ä¸€ä¸ª TE çš„æ„æˆ</p>
<ol>
<li>
<p>é¦–å…ˆæ˜¯ <code>te.placeholder</code> å°†è¿”å›ä¸€ä¸ª <code>te.tensor.Tensor</code>ã€‚ å…¶æ•°æ®ç»“æ„å®šä¹‰ä½äº <code>include/tvm/te/operation.h</code>ä¸­ï¼Œ å…·ä½“å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PlaceholderOpNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">OperationNode</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">PrimExpr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shape</span><span class="p">;</span>
<span class="w">  </span><span class="n">DataType</span><span class="w"> </span><span class="n">dtype</span><span class="p">;</span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">num_outputs</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">final</span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;};</span>
<span class="w">  </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">PrimExpr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">output_shape</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">final</span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">shape</span><span class="p">;};</span>
<span class="w">  </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">Tensor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InputTensors</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">final</span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="p">{};};</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">_type_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;PlaceholderOp&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">TVM_DECLARE_BASE_OBJECT_INFO</span><span class="p">(</span><span class="n">PlaceholderOpNode</span><span class="p">,</span><span class="w"> </span><span class="n">OperationNode</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>placeholder é€šå¸¸ç”¨äºè®¡ç®—å›¾çš„ Input èŠ‚ç‚¹ä½¿ç”¨ï¼Œæ²¡æœ‰å‰åºèŠ‚ç‚¹ï¼Œå¯èƒ½ä¹Ÿæ˜¯teä¸­æœ€å¸¸ç”¨çš„Opã€‚ é™¤äº†<code>PlaceholderOp</code> ä¹‹å¤–ï¼Œ TE ä¸­è¿˜æœ‰ä¸€äº›å…¶ä»–çš„ Op å®šä¹‰ï¼Œä¾‹å¦‚åé¢ä¼šæåˆ°çš„ <code>ComputeOp</code>ï¼Œ ä»¥åŠ <code>ExternOp</code> ç­‰ï¼Œ è¿™äº› Op æ˜¯ TE AST çš„ç»„æˆéƒ¨åˆ†ã€‚</p>
</li>
<li>
<p>æ¥ä¸‹æ¥æ˜¯ <code>te.compute</code> ï¼Œ compute ä»ä¸€ä¸ªæˆ–è€…å¤šä¸ªå‰åºèŠ‚ç‚¹æ¥æ”¶æ•°æ®ï¼Œå¹¶æŒ‰åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥çš„ lambda è¡¨è¾¾å¼è®¡ç®— Tensor å†…çš„æ•°æ®ã€‚å…¶API ç¬¬ä¸€ä¸ªä¼ å…¥å‚æ•°æ˜¯ Tensor çš„ shapeï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª lambda è¡¨è¾¾å¼ï¼Œè¡¨æ˜ Tensor çš„æ•°æ®æ˜¯å¦‚ä½•è®¡ç®—æ¥çš„ï¼Œè¿”å›ä¸€ä¸ª<code>te.tensor.Tensor</code> ã€‚ å…¶ C++ éƒ¨åˆ†æ•°æ®ç»“æ„å®šä¹‰å…·ä½“å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TVM_DLL</span><span class="w"> </span><span class="n">ComputeOpNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">BaseComputeOpNode</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">PrimExpr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">body</span><span class="p">;</span><span class="w"> </span><span class="c1">//compute expression</span>
<span class="w">  </span><span class="c1">// override functions</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">num_outputs</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">final</span><span class="p">;</span>
<span class="w">  </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">Tensor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InputTensors</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">final</span><span class="p">;</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">_type_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ComputeOp&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">TVM_DECLARE_FINAL_OBJECT_INFO</span><span class="p">(</span><span class="n">ComputeOpNode</span><span class="p">,</span><span class="w"> </span><span class="n">BaseComputeOpNode</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>å¯ä»¥çœ‹åˆ°å…¶å…³é”®æˆå‘˜åªæœ‰ä¸€ä¸ª bodyï¼Œæ˜¯ä¸€ä¸ª PrimExpr æ•°ç»„ï¼Œå› æ­¤æ¥ä¸‹æ¥çœ‹ python ç«¯æ˜¯æ€æ ·æŠŠä¸€ä¸ª lambda è¡¨è¾¾å¼è¡¨è¾¾çš„è®¡ç®—è½¬æ¢æˆäº† PrimExprï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">fcompute</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;compute&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">varargs_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">out_ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

  <span class="n">argspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">fcompute</span><span class="p">)</span>
  <span class="n">arg_names</span> <span class="o">=</span> <span class="n">argspec</span><span class="o">.</span><span class="n">args</span>

  <span class="c1"># 1. å°†ä¼ å…¥çš„ shape è½¬æˆ tir.IterVar åˆ—è¡¨</span>
  <span class="n">dim_var</span> <span class="o">=</span> <span class="p">[</span><span class="n">tvm</span><span class="o">.</span><span class="n">tir</span><span class="o">.</span><span class="n">IterVar</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arg_names</span><span class="p">,</span> <span class="n">shape</span><span class="p">[:</span><span class="n">out_ndim</span><span class="p">])]</span>

  <span class="c1"># 2. æ„é€ è®¡ç®—çš„ AST</span>
  <span class="n">body</span> <span class="o">=</span> <span class="n">fcompute</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dim_var</span><span class="p">])</span>

  <span class="c1"># 3. è°ƒç”¨ C++ API è·å– compute_op_node</span>
  <span class="n">body</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="c1"># å°†List[PrimExpr] è½¬æˆ Array&lt;PrimExpr&gt;</span>
  <span class="n">op_node</span> <span class="o">=</span> <span class="n">_ffi_api</span><span class="o">.</span><span class="n">ComputeOp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">dim_var</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">op_node</span><span class="o">.</span><span class="n">output</span>
</code></pre></div>
<p>è¿™é‡Œçš„å…³é”®ç‚¹åœ¨äº <code>IterVar</code> ç»§æ‰¿äº† <code>ExprOp</code>ï¼ˆä½äº <code>python/tvm/tir/expr.py</code>ï¼‰ï¼Œ è€Œ <code>ExprOp</code> é‡è½½äº†å››åˆ™è¿ç®—ï¼Œç§»ä½è¿ç®—ï¼Œæ¯”è¾ƒè¿ç®—ç­‰æ“ä½œç¬¦ï¼Œå› æ­¤å¯ä»¥ç›´æ¥è¢« lambda è¡¨è¾¾å¼æ“ä½œï¼Œè°ƒç”¨é‡è½½çš„è¿ç®—ç¬¦è¿”å›è¡¨ç¤ºè¿ç®—ä¹‹åçš„è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">Z</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">compute</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div>
<p>é¦–å…ˆå¯¹äº <code>X[i]</code>å’Œ<code>Y[i]</code> ä¼šåˆ†åˆ«æ„é€ ä¸€ä¸ª <code>tir.expr.ProducerLoad</code> è¡¨è¾¾å¼ï¼Œæ¥ç€è¿™ä¸¤ä¸ªè¡¨è¾¾å¼çš„ä¹˜æ³•ä¼šè°ƒç”¨åˆ° <code>ExprOp</code> é‡è½½çš„ä¹˜æ³•è¿ç®—ç¬¦ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">span</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">_ffi_api</span><span class="o">.</span><span class="n">_OpMul</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">span</span><span class="p">)</span>
</code></pre></div>
<p>è¿”å›ä¸€ä¸ª <code>tir.Mul</code> Exprï¼›å…¶å®ƒçš„è¿ç®—ç±»ä¼¼ã€‚<strong>å€¼å¾—æ³¨æ„çš„æ˜¯</strong> TE ä¸­ä¹Ÿæä¾›äº†æ§åˆ¶ç±» PrimExpr çš„å°è£…ï¼Œä¾‹å¦‚ <code>te.if_then_else</code>ï¼›ä»¥åŠ <code>te.extern_primfunc</code> ç”¨å…¶å®ƒPrimFunc æ¥åˆ›å»º PrimExpr</p>
</li>
<li>
<p>åœ¨æ„é€ è¡¨ç¤ºè®¡ç®—çš„ AST ä¹‹åï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªä»lambdaæ„é€ å‡ºæ¥çš„ PrimExpr æ•°ç»„ä¼ å…¥äº†<code>_ffi_api.ComputeOp</code>ï¼Œ è¿”å›ä¸€ä¸ª ComputeOp ç±»å‹ï¼Œ <code>ComputeOp</code> æ˜¯ <code>te::Operation</code> çš„ä¸€ä¸ªå­ç±»ï¼Œå› æ­¤å¯ä»¥ä»å…¶<code>output</code>æ–¹æ³•æ‹¿åˆ°è®¡ç®—ç»“æœ <code>Tensor</code> ä½œä¸º <code>te.compute</code> çš„è¿”å›ç»“æœ</p>
</li>
</ol>
<p>ğŸ’¡<strong>åœ¨è¿™é‡Œæ€»ç»“ä¸€ä¸‹ TE çš„æ„æˆå…³é”®å…ƒç´ </strong>ï¼š å³ <code>Tensor</code> å’Œ <code>Operation</code> ä¸¤ä¸ªç±»å‹ã€‚å‰è€…è¡¨å¾ä¸€ä¸ªå¼ é‡çš„å½¢çŠ¶ã€å…ƒç´ ç±»å‹ã€source operationç­‰ï¼›åè€…è¡¨ç¤ºäº§ç”Ÿ Tensor çš„ä¸€ç§æ“ä½œï¼ŒåŒ…æ‹¬è¡¨ç¤ºè¾“å…¥çš„æ“ä½œ PlaceholderOpï¼Œ è¡¨ç¤ºè®¡ç®—é€»è¾‘çš„æ“ä½œ ComputeOp ç­‰ã€‚</p>
<div class="autocb" style="text-align:center;"><img src="./tvm-lowering.assets\autocb_1.png" style="zoom: 50%;box-shadow: rgba(0, 0, 0, 0.5) 10px 10px 10px; border-radius: 10px;" /></div>

<hr />
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹å…³æ³¨ <code>te.create_prim_func</code> æ˜¯å¦‚ä½• å°† TE lower åˆ° PrimFunc çš„ï¼Œå¯¹åº”åˆ°<code>src/te/operation/create_prim_func.cc</code> ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">PrimFunc</span><span class="w"> </span><span class="nf">CreatePrimFuncWithConstants</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">te</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">arg_list</span><span class="p">,</span>
<span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">runtime</span><span class="o">::</span><span class="n">NDArray</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">constants</span><span class="p">,</span>
<span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Array</span><span class="o">&lt;</span><span class="n">tir</span><span class="o">::</span><span class="n">Var</span><span class="o">&gt;&gt;&amp;</span><span class="w"> </span><span class="n">tir_var_list</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">DataType</span><span class="o">&gt;</span><span class="w"> </span><span class="n">index_dtype_override</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Infomations used in CreatePrimFunc and its sub-functions.</span>
<span class="w">  </span><span class="n">CreateFuncInfo</span><span class="w"> </span><span class="n">info</span><span class="p">(</span><span class="n">arg_list</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// Root body stmts.</span>
<span class="w">  </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">Stmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">root_stmts</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// Analyzer</span>
<span class="w">  </span><span class="n">arith</span><span class="o">::</span><span class="n">Analyzer</span><span class="w"> </span><span class="n">analyzer</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Step 1. åç»­éå†è®¡ç®—å›¾ï¼š placeholderè¢«æ”¾åˆ°å‰é¢ï¼Œæœ€ç»ˆcomputeOpåœ¨æœ€å</span>
<span class="w">  </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">te</span><span class="o">::</span><span class="n">Operation</span><span class="o">&gt;</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CollectOrderedOps</span><span class="p">(</span><span class="n">arg_list</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Step 2. è¿™æ®µé€»è¾‘æ˜¯å¤„ç† TE ä¸­åæ¥å¼•å…¥çš„ ExternOpï¼Œåœ¨æœ¬ä¾‹ä¸­æ— éœ€è€ƒè™‘</span>
<span class="w">  </span><span class="n">InitializeBufferBinds</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Step 3. å¦‚æœæ˜¯ placeholderï¼Œåˆ›å»ºå¯¹åº”çš„ tir.Bufferï¼›å¦‚æœæ˜¯computeï¼Œåˆ›å»ºå¯¹åº”çš„ tir.Stmtï¼›å¦‚æœæ˜¯ externï¼Œåˆ™åˆ›å»ºä¸€ä¸ª tir.Stmt èŠ‚ç‚¹</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">te</span><span class="o">::</span><span class="n">Operation</span><span class="o">&amp;</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">RewriteStageToBlock</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">root_stmts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">analyzer</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// åˆ›å»ºå¹¶è¿”å› PrimFunc</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GenerateAndCompletePrimFunc</span><span class="p">(</span><span class="n">arg_list</span><span class="p">,</span><span class="w"> </span><span class="n">root_stmts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">tir_var_list</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">func</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>å›é¡¾ä¸‹ PrimFunc çš„ç»“æ„ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PrimFuncNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">BaseFuncNode</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">tir</span><span class="o">::</span><span class="n">Var</span><span class="o">&gt;</span><span class="w"> </span><span class="n">params</span><span class="p">;</span>
<span class="w">  </span><span class="n">tir</span><span class="o">::</span><span class="n">Stmt</span><span class="w"> </span><span class="n">body</span><span class="p">;</span>
<span class="w">  </span><span class="n">Type</span><span class="w"> </span><span class="n">ret_type</span><span class="p">;</span>
<span class="w">  </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">tir</span><span class="o">::</span><span class="n">Var</span><span class="p">,</span><span class="w"> </span><span class="n">Buffer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buffer_map</span><span class="p">;</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">_type_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tir.PrimFunc&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">TVM_DECLARE_FINAL_OBJECT_INFO</span><span class="p">(</span><span class="n">PrimFuncNode</span><span class="p">,</span><span class="w"> </span><span class="n">BaseFuncNode</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p><code>GenerateAndCompletePrimFunc</code> ä¼šå°† <code>arg_list</code>(<code>Array&lt;te::Tensor&gt;</code>) è½¬æˆä¸€ä¸ª <code>Array&lt;tir::Var&gt;</code> ä½œä¸ºå‡½æ•°çš„ paramsï¼› è€Œå‡½æ•° body å’Œ <code>buffer_map</code> å·²ä»å»ºç«‹çš„è®¡ç®—å›¾ä¸­å¾—åˆ°ï¼›å› æ­¤åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº†ä» TE åˆ° <code>PrimFunc</code> çš„è½¬æ¢ã€‚</p>
<p>ğŸ’¡æ€»ç»“æ•´ä¸ªè¿‡ç¨‹ï¼Œæœ€æ ¸å¿ƒçš„éƒ¨åˆ†åœ¨äºåç»­éå† TE è¡¨ç¤ºçš„è®¡ç®—å›¾ï¼ˆOperationä½œä¸ºèŠ‚ç‚¹ï¼Œé€šè¿‡ <code>InputTensors</code> æ–¹æ³•æ‹¿åˆ°æ‰€æœ‰å…¥è¾¹ï¼Œåš DFSï¼‰ï¼Œè½¬æ¢æˆå¯¹åº”çš„ <code>tir.Buffer</code> å’Œ <code>tir.Stmt</code> å³ tir ä¸­çš„ AST</p>
<h2 id="3-lower-relay">3. Lower Relay</h2>
<p>è¿™ä¸€èŠ‚å…³æ³¨ä¸€ä¸ªæ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ï¼Œ TVM ä¸­å›¾çº§åˆ« IR Relay çš„ lowering</p>
<div class="autocb" style="text-align:center;"><img src="./tvm-lowering.assets\autocb_2.png" style="zoom: 50%;box-shadow: rgba(0, 0, 0, 0.5) 10px 10px 10px; border-radius: 10px;" /></div>

<p>ä»è¿™å¼ å›¾å¯ä»¥çœ‹åˆ°ï¼Œ Relay è¦åˆ° TIR æœ‰2æ¡è·¯å¾„ï¼Œç¬¬ä¸€æ¡å°±æ˜¯ç›´æ¥åˆ° TIRï¼Œ æ¯”å¦‚ PrimExpr æ´¾ç”Ÿçš„èŠ‚ç‚¹ IntImmNode å¯ä»¥ç›´æ¥æ˜ å°„åˆ° TIR ï¼Œå¦å¤–ä¸€æ¡å°±æ˜¯ Relay é‡Œé¢ç±»ä¼¼ Conv çš„ Op çš„è®¡ç®—é€»è¾‘æ˜¯ç”¨ TOPI æ¥è¡¨è¾¾çš„ï¼Œ TOPI æ˜¯ TVM ä¸­ç”¨ TE æ¥è¡¨ç¤ºå¸¸ç”¨ç®—å­çš„é¢„å®šä¹‰åº“ã€‚</p>
<h3 id="31-topi">3.1. TOPI</h3>
<p>è€ƒè™‘è¿™ä¸ªä¾‹å­ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">n</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">&quot;j&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">placeholder</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">reduce_axis</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">compute</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">te</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">k</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>

<span class="c1"># ä½¿ç”¨ TOPI: è¿™ä¸€å¥ä¸ä¸Šé¢ä¸¤å¥ç­‰ä»·</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">topi</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 

<span class="c1"># å¯ä»¥åˆ©ç”¨ä¸Šä¸€èŠ‚çš„ä»£ç ï¼Œ å°† TE lower åˆ° tir æŸ¥çœ‹è¡¨ç¤ºï¼š</span>
<span class="n">prim_func1</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">create_prim_func</span><span class="p">([</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">])</span>
<span class="n">prim_func2</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">create_prim_func</span><span class="p">([</span><span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[31m</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="s2">prim_func1</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m</span><span class="se">\n</span><span class="si">{</span><span class="n">prim_func1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[31m</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="s2">prim_func2</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m</span><span class="se">\n</span><span class="si">{</span><span class="n">prim_func2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Build ä¹‹åè¿è¡Œç»“æœå½“ç„¶ä¹Ÿæ˜¯ç›¸åŒçš„ï¼š</span>
<span class="n">prim_func1</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">create_prim_func</span><span class="p">([</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">])</span>
<span class="n">prim_func2</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">create_prim_func</span><span class="p">([</span><span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">])</span>

<span class="n">lib1</span><span class="p">,</span> <span class="n">lib2</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">prim_func1</span><span class="p">),</span> <span class="n">tvm</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">prim_func2</span><span class="p">)</span>

<span class="n">a_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">expected_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a_np</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">a_nd1</span><span class="p">,</span> <span class="n">a_nd2</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a_np</span><span class="p">),</span> <span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a_np</span><span class="p">)</span>
<span class="n">test_res1</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">128</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">test_res2</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">128</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>

<span class="n">lib1</span><span class="p">(</span><span class="n">a_nd1</span><span class="p">,</span> <span class="n">test_res1</span><span class="p">)</span>
<span class="n">lib2</span><span class="p">(</span><span class="n">a_nd2</span><span class="p">,</span> <span class="n">test_res2</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">expected_res</span><span class="p">,</span> <span class="n">test_res1</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">expected_res</span><span class="p">,</span> <span class="n">test_res2</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ğŸ‰</span><span class="se">\033</span><span class="s2">[32mTest Pass...</span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>
</code></pre></div>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºæ±‚å’Œè¿™æ ·å¸¸è§çš„ç®€å•æ“ä½œï¼Œå¦‚æœåªä½¿ç”¨ te çš„è¯ï¼Œä¹Ÿéœ€è¦å…ˆå®šä¹‰ä¸€ä¸ª reduce_axis, å†ç”¨ lambda é£æ ¼å»å£°æ˜ï¼Œæ¯”è¾ƒç¹çï¼Œæ›´ä¸å¿…è¯´åœ¨ç¥ç»ç½‘ç»œä¸­å¤§é‡ä½¿ç”¨çš„å…¶å®ƒæ›´å¤æ‚ä¸€ç‚¹çš„ç®—å­ï¼Œå¦‚æœç”¨ te å»å†™çš„è¯ï¼Œä¼šæ¯”è¾ƒéº»çƒ¦ã€‚ å› æ­¤ TVM æä¾›äº†ä¸€äº›ä½¿ç”¨ TE å®šä¹‰çš„ç°æˆçš„ç®—å­ï¼ŒæŠŠä»–ä»¬æ”¾åˆ°ä¸€èµ·ï¼ˆä»¥åŠä¸€äº› schedule æ“ä½œï¼‰ï¼Œç§°ä½œ TOPI(Tensor operator inventory)</p>
<p>TOPI ä¸­åŒ…å«äº†å¦‚ å·ç§¯ï¼Œ softmaxï¼Œ çŸ©é˜µä¹˜ ç­‰å¸¸è§çš„ç®—å­ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„è¡¨è¾¾ DL ä¸­å¸¸è§çš„è®¡ç®—è¿‡ç¨‹ã€‚</p>
<p>åœ¨çœ‹å…·ä½“å®ç°å‰å¯ä»¥é¦–å…ˆè§‚å¯Ÿä¸€ä¸‹ TOPI çš„ç›®å½•ç»“æ„ï¼ŒåŒ…å«äº† <code>nn.cc</code>ï¼Œ<code>elemwise.cc</code>ï¼Œ<code>schedule.cc</code>ç­‰ï¼Œåˆ†åˆ«å¯¹åº”äº†æœºå™¨å­¦ä¹ å¸¸è§ç®—å­ï¼Œelement wise è¿ç®—ï¼ˆå¦‚ä¸Šé¢ä¾‹å­ä¸­çš„ <code>topi.sum</code>ï¼‰ï¼Œ ç®—å­è°ƒåº¦ï¼›åœ¨è¿™äº›æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨ <code>TVM_REGISTER_GLOBAL</code> æ³¨å†Œäº† TOPI ä¸­çš„å…·ä½“å®ç°ã€‚</p>
<p>ğŸ’¡è¿™é‡Œæˆ‘ä»¬ä»¥ <code>topi.matmul</code> ä¸ºä¾‹çœ‹ä¸€ä¸‹å®ç°ã€‚</p>
<p><code>topi.matmul</code> å¯¹åº” C++ æ³¨å†Œåœ¨<code>src/topi/nn.cc</code> ä¸­ï¼Œå®ç°åœ¨<code>include/tvm/topi/nn/dense.h</code>ä¸­ï¼Œç®€åŒ–åå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="kr">inline</span><span class="w"> </span><span class="n">tvm</span><span class="o">::</span><span class="n">te</span><span class="o">::</span><span class="n">Tensor</span><span class="w"> </span><span class="n">matmul</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">tvm</span><span class="o">::</span><span class="n">te</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&amp;</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">tvm</span><span class="o">::</span><span class="n">te</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&amp;</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="kt">bool</span><span class="w"> </span><span class="n">trans_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">trans_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;T_matmul&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kMatMul</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">tvm</span><span class="o">::</span><span class="n">Array</span><span class="o">&lt;</span><span class="n">tvm</span><span class="o">::</span><span class="n">PrimExpr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">output_shape</span><span class="p">{</span><span class="n">A</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">[</span><span class="n">trans_a</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">B</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">[</span><span class="n">trans_b</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">]};</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tvm</span><span class="o">::</span><span class="n">te</span><span class="o">::</span><span class="n">reduce_axis</span><span class="p">(</span><span class="n">tvm</span><span class="o">::</span><span class="n">Range</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">[</span><span class="n">trans_a</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">]},</span><span class="w"> </span><span class="s">&quot;k&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">tvm</span><span class="o">::</span><span class="n">tir</span><span class="o">::</span><span class="n">Var</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">tvm</span><span class="o">::</span><span class="n">tir</span><span class="o">::</span><span class="n">Var</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tvm</span><span class="o">::</span><span class="n">sum</span><span class="p">((</span><span class="n">trans_a</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">trans_b</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">B</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]),</span><span class="w"> </span><span class="p">{</span><span class="n">k</span><span class="p">});</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">tvm</span><span class="o">::</span><span class="n">te</span><span class="o">::</span><span class="n">compute</span><span class="p">(</span><span class="n">output_shape</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>å¯ä»¥çœ‹åˆ°å…¶å® <code>dense</code> è·Ÿæˆ‘ä»¬æ‰‹å†™çš„æ²¡æœ‰ä»€ä¹ˆä¸åŒï¼Œä½†æ˜¯å¯¹äº logsoftmax ä¹‹ç±»æœ‰å®ç°æŠ€å·§çš„ç®—å­ï¼ŒTOPI æœ‰å¾ˆå¥½çš„å®ç°å¹¶ä¸”æœ‰ç›¸åº”çš„è°ƒåº¦å¯ä»¥ä½¿ç”¨ã€‚</p>
<blockquote>
<p>TOPI ä¸­æœ‰äº›ç®—å­åœ¨C++ å’Œ python ç«¯åˆ†åˆ«å®ç°äº†ä¸€æ¬¡ï¼Œè¿™æ ·åšçš„åŸå› è§ï¼š https://discuss.tvm.apache.org/t/why-topi-is-implemented-in-both-c-and-python/50/7</p>
<p>ç®€å•æ¥è¯´ï¼Œå½“ä¸€ä¸ªç®—å­åœ°è°ƒåº¦æ–¹å¼ç¨³å®šä¹‹åï¼Œä¼šè¢«æ”¾åœ¨C++éƒ¨åˆ†ï¼Œ æ­£åœ¨devåœ°æ”¾åœ¨pythonå®ç°ï¼›è€Œå¯¹äºä¸€äº›ç®€å•çš„ç®—å­ï¼Œå°±ä¿ç•™äº†åœ¨ C++ å’Œ py ä¸¤éƒ¨åˆ†çš„å®ç°</p>
</blockquote>
<h3 id="32-relay-graphexecutor">3.2. Relay-GraphExecutor</h3>
<p>æœ¬èŠ‚ä½¿ç”¨å¦‚ä¸‹ä¾‹å­ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tvm</span>
<span class="kn">from</span> <span class="nn">tvm</span> <span class="kn">import</span> <span class="n">relay</span>

<span class="c1"># 1. å®šä¹‰ Relay Var</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">784</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">weight1</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">&quot;weight1&quot;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="mi">784</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">bias1</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">&quot;bias1&quot;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">weight2</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">&quot;weight2&quot;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">128</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">bias2</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">&quot;bias2&quot;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>

<span class="c1"># 2. ä½¿ç”¨ Relay Op å®šä¹‰ç½‘ç»œç»“æ„</span>
<span class="n">dense1</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">weight1</span><span class="p">)</span>
<span class="n">bias_add1</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">bias_add</span><span class="p">(</span><span class="n">dense1</span><span class="p">,</span> <span class="n">bias1</span><span class="p">)</span>
<span class="n">relu1</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">bias_add1</span><span class="p">)</span>
<span class="n">dense2</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">relu1</span><span class="p">,</span><span class="n">weight2</span><span class="p">)</span>
<span class="n">bias_add2</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">bias_add</span><span class="p">(</span><span class="n">dense2</span><span class="p">,</span> <span class="n">bias2</span><span class="p">)</span>
<span class="n">relu2</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">bias_add2</span><span class="p">)</span>

<span class="c1"># 3. æ„å»ºç½‘ç»œ</span>
<span class="n">func</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">Function</span><span class="p">([</span><span class="n">data</span><span class="p">,</span><span class="n">weight1</span><span class="p">,</span><span class="n">bias1</span><span class="p">,</span><span class="n">weight2</span><span class="p">,</span><span class="n">bias2</span><span class="p">],</span><span class="n">relu2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[31m</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="s2">relay func</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m</span><span class="se">\n</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 4. æ„å»º IRModule</span>
<span class="n">ir_mod</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">IRModule</span><span class="o">.</span><span class="n">from_expr</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

<span class="c1"># 5. è°ƒç”¨ relay.build è¿›è¡Œæ„å»º</span>
<span class="c1"># relay.build ç›®å‰æš‚æ—¶æ”¯æŒç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ `relay.Function`ï¼Œ ä½†æ˜¯ä¹‹åå°†åªæ”¯æŒ IRModule</span>
<span class="k">with</span> <span class="n">tvm</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">PassContext</span><span class="p">(</span><span class="n">opt_level</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
  <span class="n">rt_lib</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">ir_mod</span><span class="o">=</span><span class="n">ir_mod</span><span class="p">,</span><span class="n">target</span><span class="o">=</span><span class="s2">&quot;llvm&quot;</span><span class="p">)</span>

<span class="c1"># 6. ä½¿ç”¨ graph_executor åŠ è½½ build å¥½çš„è®¡ç®—å›¾å¹¶æ‰§è¡Œ</span>
<span class="n">dev</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;float32&quot;</span>
<span class="n">graph_module</span> <span class="o">=</span> <span class="n">graph_executor</span><span class="o">.</span><span class="n">GraphModule</span><span class="p">(</span><span class="n">rt_lib</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">](</span><span class="n">dev</span><span class="p">))</span>
<span class="c1"># Set inputs: è¿™é‡Œåªè®¾ç½®ä¸€éƒ¨åˆ†å‚æ•°ï¼Œå› ä¸ºparams çš„å†…å­˜å·²ç»åœ¨ relay.build é˜¶æ®µ åˆ†é…å¥½å†…å­˜åŒ…å«åœ¨ graphmodule ä¸­ï¼Œ å› æ­¤è¿™é‡Œçš„ä»£ç ä¹Ÿèƒ½è·‘é€š</span>

<span class="c1"># Execute &amp;&amp; Get outputs</span>
<span class="n">graph_module</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">graph_exec_output</span> <span class="o">=</span> <span class="n">graph_module</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">graph_exec_output</span><span class="p">)</span>
</code></pre></div>
<p>è¿™é‡Œä»¥ <code>dense</code> ç®—å­ä¸ºä¾‹ï¼Œ é¦–å…ˆå…³æ³¨ <code>dense1 = relay.nn.dense(data,weight1)</code> ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">dense</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_dtype</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">_make</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">out_dtype</span><span class="p">)</span>
</code></pre></div>
<p>åœ¨ C++ ç«¯ä½¿ç”¨ RELAY_REGISTER_OP æœºåˆ¶ç»Ÿä¸€ç®¡ç† Relay Opï¼Œ <code>dense</code>ç®—å­çš„æ³¨å†Œä½äº <code>src/relay/op/nn/nn.cc</code> ä¸­ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">Expr</span><span class="w"> </span><span class="nf">MakeDense</span><span class="p">(</span><span class="n">Expr</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">Expr</span><span class="w"> </span><span class="n">weight</span><span class="p">,</span><span class="w"> </span><span class="n">IndexExpr</span><span class="w"> </span><span class="n">units</span><span class="p">,</span><span class="w"> </span><span class="n">DataType</span><span class="w"> </span><span class="n">out_dtype</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_object</span><span class="o">&lt;</span><span class="n">DenseAttrs</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">  </span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">units</span><span class="p">;</span>
<span class="w">  </span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">out_dtype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out_dtype</span><span class="p">;</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Op</span><span class="o">&amp;</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Op</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="s">&quot;nn.dense&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Call</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="p">},</span><span class="w"> </span><span class="n">Attrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">),</span><span class="w"> </span><span class="p">{});</span>
<span class="p">}</span>

<span class="n">TVM_REGISTER_GLOBAL</span><span class="p">(</span><span class="s">&quot;relay.op.nn._make.dense&quot;</span><span class="p">).</span><span class="n">set_body_typed</span><span class="p">(</span><span class="n">MakeDense</span><span class="p">);</span>

<span class="n">RELAY_REGISTER_OP</span><span class="p">(</span><span class="s">&quot;nn.dense&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">describe</span><span class="p">(</span><span class="cm">/*çœç•¥*/</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">set_attrs_type</span><span class="o">&lt;</span><span class="n">DenseAttrs</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">set_num_inputs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nD Tensor&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Input data.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;weight&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;2D Tensor&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Weight matrix.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">set_support_level</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">set_attr</span><span class="o">&lt;</span><span class="n">FInferCorrectLayout</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;FInferCorrectLayout&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DenseInferCorrectLayout</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_type_rel</span><span class="p">(</span><span class="s">&quot;Dense&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">MatmulRel</span><span class="o">&lt;</span><span class="n">DenseAttrs</span><span class="o">&gt;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">set_attr</span><span class="o">&lt;</span><span class="n">TOpPattern</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;TOpPattern&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">kOutEWiseFusable</span><span class="p">);</span>
</code></pre></div>
<p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆè¿”å›çš„å°±æ˜¯ä¸€ä¸ª <code>CallNode</code>ï¼Œ Op æ˜¯ <code>dense</code>ã€‚</p>
<p>åŒæ—¶æ³¨æ„åˆ° <code>RELAY_REGISTER_OP("nn.dense")</code> åªæ˜¯è®¾ç½®äº†è¾“å…¥è¾“å‡º type å…³ç³»ï¼Œä»¥åŠå…¶å®ƒçš„ä¸€äº›ç›¸å…³å±æ€§ï¼Œ æ²¡æœ‰æŒ‡å®š <code>dense</code> è¿™ä¸ªç®—å­å…·ä½“çš„è®¡ç®—å’Œè°ƒåº¦ï¼Œ é‚£ä¹ˆä¸€ä¸ª Relay ç®—å­çš„è®¡ç®—å’Œè°ƒåº¦åœ¨å“ªé‡ŒæŒ‡å®šå‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯åœ¨ python ç«¯ï¼Œ ä»¥<code>dense</code>ä¸ºä¾‹ï¼Œ å…¶è°ƒåº¦å’Œè®¡ç®—çš„æŒ‡å®šä½äº <code>python/tvm/relay/op/nn/_nn.py</code> ä¸­ï¼Œ è¯¥æ–‡ä»¶ä¼šåœ¨ <code>import relay</code> æ—¶è¢«è‡ªåŠ¨åŠ è½½ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1"># dense</span>
<span class="n">reg</span><span class="o">.</span><span class="n">register_strategy</span><span class="p">(</span><span class="s2">&quot;nn.dense&quot;</span><span class="p">,</span> <span class="n">strategy</span><span class="o">.</span><span class="n">dense_strategy</span><span class="p">)</span>
</code></pre></div>
<p><code>strategy.dense_strategy</code> å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="nd">@override_native_generic_func</span><span class="p">(</span><span class="s2">&quot;dense_strategy&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dense_strategy</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">out_type</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;dense generic strategy&quot;&quot;&quot;</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;dense is not optimized for this platform.&quot;</span><span class="p">)</span>
  <span class="n">strategy</span> <span class="o">=</span> <span class="n">_op</span><span class="o">.</span><span class="n">OpStrategy</span><span class="p">()</span>
  <span class="n">strategy</span><span class="o">.</span><span class="n">add_implementation</span><span class="p">(</span>
    <span class="n">wrap_compute_dense</span><span class="p">(</span><span class="n">topi</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dense</span><span class="p">),</span>
    <span class="n">wrap_topi_schedule</span><span class="p">(</span><span class="n">topi</span><span class="o">.</span><span class="n">generic</span><span class="o">.</span><span class="n">schedule_dense</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dense.generic&quot;</span><span class="p">,</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="n">strategy</span>
</code></pre></div>
<p>å…¶ä¸­ <code>topi.nn.dense</code> å’Œ <code>topi.generic.schedule_dense</code> å°±æ˜¯ ä¸Šä¸€èŠ‚ TOPI ä¸­é¢„å®šä¹‰å¥½çš„ TE è¡¨ç¤ºçš„ç®—å­åº“ä¸­çš„ç®—å­ã€‚ è€Œ <code>_op.OpStrategy</code> å¯¹åº” C++ ä¸­çš„æ•°æ®ç»“æ„ä½äº <code>include/tvm/relay/op_strategy.h</code> ä¸­ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OpImplementationNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">FTVMCompute</span><span class="w"> </span><span class="n">fcompute</span><span class="p">;</span>
<span class="w">  </span><span class="n">FTVMSchedule</span><span class="w"> </span><span class="n">fschedule</span><span class="p">;</span>
<span class="w">  </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">plevel</span><span class="p">;</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">_type_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;relay.OpImplementation&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">TVM_DECLARE_FINAL_OBJECT_INFO</span><span class="p">(</span><span class="n">OpImplementationNode</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>å…¶ä¸­ <code>FTVMCompute</code> æ˜¯ <code>runtime::TypedPackedFunc&lt;Array&lt;te::Tensor&gt;(const Attrs&amp; attrs, const Array&lt;te::Tensor&gt;&amp; inputs, const Type&amp; out_type)&gt;;</code> ï¼Œ FTVMSchedule æ˜¯ <code>runtime::TypedPackedFunc&lt;te::Schedule(const Attrs&amp; attrs, const Array&lt;te::Tensor&gt;&amp; outs, const Target&amp; target)&gt;;</code>ï¼›</p>
<p>ğŸ’¡<strong>è¿™æ ·å°±å°† TOPI å’Œ Relay Op å»ºç«‹äº†è”ç³»</strong></p>
<p>æ¥ä¸‹æ¥å…³æ³¨ <code>relay.build</code></p>
<hr />
<p>å…ˆæš‚æ—¶å¿½ç•¥ <code>PassContext(opt_level=2)</code>ï¼Œ ç›´æ¥çœ‹ <code>relay.build</code>ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">ir_mod</span><span class="p">,</span><span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">executor</span><span class="o">=</span><span class="n">Executor</span><span class="p">(</span><span class="s2">&quot;graph&quot;</span><span class="p">),</span> <span class="n">runtime</span><span class="o">=</span><span class="n">Runtime</span><span class="p">(</span><span class="s2">&quot;cpp&quot;</span><span class="p">),</span>
          <span class="n">workspace_memory_pools</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constant_memory_pools</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mod_name</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
<span class="p">):</span>
  <span class="n">raw_targets</span> <span class="o">=</span> <span class="n">Target</span><span class="o">.</span><span class="n">canon_multi_target_and_host</span><span class="p">(</span><span class="n">Target</span><span class="o">.</span><span class="n">target_or_current</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="n">target_host</span><span class="p">)</span>
  <span class="n">target_host</span> <span class="o">=</span> <span class="n">raw_targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">host</span>

  <span class="c1"># å¦‚æœå½“å‰ dispatch context æ˜¯ fallback context (the default root context),</span>
  <span class="c1"># ä» TopHub ä¸­ load pre-tuned parameters</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">autotvm</span><span class="o">.</span><span class="n">DispatchContext</span><span class="o">.</span><span class="n">current</span><span class="p">,</span> <span class="n">autotvm</span><span class="o">.</span><span class="n">FallbackContext</span><span class="p">):</span>
    <span class="n">tophub_context</span> <span class="o">=</span> <span class="n">autotvm</span><span class="o">.</span><span class="n">tophub</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">raw_targets</span><span class="p">))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">tophub_context</span> <span class="o">=</span> <span class="n">autotvm</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">EmptyContext</span><span class="p">()</span>

  <span class="k">with</span> <span class="n">tophub_context</span><span class="p">:</span>
    <span class="n">bld_mod</span> <span class="o">=</span> <span class="n">BuildModule</span><span class="p">()</span>
    <span class="n">graph_json</span><span class="p">,</span> <span class="n">runtime_mod</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">bld_mod</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
      <span class="n">mod</span><span class="o">=</span><span class="n">ir_mod</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">raw_targets</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
      <span class="n">executor</span><span class="o">=</span><span class="n">executor</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="n">runtime</span><span class="p">,</span>
      <span class="n">workspace_memory_pools</span><span class="o">=</span><span class="n">workspace_memory_pools</span><span class="p">,</span>
      <span class="n">constant_memory_pools</span><span class="o">=</span><span class="n">constant_memory_pools</span><span class="p">,</span>
      <span class="n">mod_name</span><span class="o">=</span><span class="n">mod_name</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># build ä¹‹å bld_mod ä¸­åŒ…å« IRModuleï¼ˆå…¶ä¸­ä¸º PrimFuncï¼‰</span>
    <span class="n">func_metadata</span> <span class="o">=</span> <span class="n">bld_mod</span><span class="o">.</span><span class="n">get_function_metadata</span><span class="p">()</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">bld_mod</span><span class="o">.</span><span class="n">get_devices</span><span class="p">()</span>
    <span class="n">lowered_ir_mods</span> <span class="o">=</span> <span class="n">bld_mod</span><span class="o">.</span><span class="n">get_irmodule</span><span class="p">()</span>
    <span class="n">executor_codegen_metadata</span> <span class="o">=</span> <span class="n">bld_mod</span><span class="o">.</span><span class="n">get_executor_codegen_metadata</span><span class="p">()</span>
    <span class="c1"># è¿™é‡Œåªçœ‹ graph_executor å»æ‰äº†aot ç›¸å…³</span>
    <span class="k">if</span> <span class="n">executor</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;graph&quot;</span><span class="p">:</span>
      <span class="n">executor_factory</span> <span class="o">=</span> <span class="n">_executor_factory</span><span class="o">.</span><span class="n">GraphExecutorFactoryModule</span><span class="p">(</span>
        <span class="n">ir_mod</span><span class="p">,</span> <span class="n">raw_targets</span><span class="p">,</span> <span class="c1"># åŸå§‹(Relay)IRModule; build target</span>
        <span class="n">executor</span><span class="p">,</span> <span class="n">graph_json</span><span class="p">,</span> <span class="n">runtime_mod</span><span class="p">,</span>  <span class="c1"># executor-config; graphä¿¡æ¯; buildåçš„ runtime module</span>
        <span class="n">mod_name</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">func_metadata</span><span class="p">,</span>  <span class="c1"># runtime.module name; æ¨¡å‹å‚æ•°; å‡½æ•°ä¿¡æ¯</span>
      <span class="p">)</span>
    <span class="k">return</span> <span class="n">executor_factory</span>
</code></pre></div>
<p>å‡½æ•°æœ€ç»ˆè¿”å›ä¸€ä¸ª <code>relay.backend.executor_factory.ExecutorFactoryModule</code> ï¼Œ æ˜¯relayçš„ graph executor factoryï¼ˆ <code>ExecutorFactoryModule</code> ç›®å‰æœ‰ graph å’Œ aot ä¸¤ç§ï¼Œ åœ¨æœ¬ä¾‹å­ä¸­ä¸º <code>graph_executor</code>ï¼‰</p>
<p>æ•´ä¸ªæ„å»ºæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>
<p>TopHub å¯»æ‰¾å†å²ä¼˜åŒ–ä¿¡æ¯:</p>
<blockquote>
<p>é¦–å…ˆ Relay ä¼šå¯»æ‰¾æ˜¯å¦æœ‰ AutoTVM é¢„å…ˆ Fintune çš„è®°å½•ï¼Œå¦‚æœæ²¡æœ‰é‚£ä¹ˆå°±ä½¿ç”¨autotvm.FallbackContextè¿™ä¸ªç¯å¢ƒä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¦‚æœæœ‰é‚£ä¹ˆæ¥ä¸‹æ¥çš„æ‰€æœ‰æ“ä½œéƒ½åœ¨ tophub_context çš„ scope ä¹‹ä¸‹ (with tophub_context:)ã€‚å€¼å¾—ä¸€æçš„æ˜¯ Relay è€ƒè™‘äº†å¼‚æ„æƒ…æ™¯ä¸‹çš„ä»£ç ç”Ÿæˆï¼Œç”¨æˆ·å¯ä»¥æŒ‡å®šå¤šä¸ªç”Ÿæˆä»£ç çš„ç›®æ ‡ (target)ã€‚</p>
</blockquote>
<p>TODO:</p>
</li>
<li>
<p>åœ¨ <code>tophub_context</code>ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ª <code>BuildModule</code> ï¼Œè°ƒç”¨ <code>build</code> ã€‚ <code>bld_mod.build</code> åœ¨ python ç«¯çš„è¿”å›å€¼æœ‰ä¸‰ä¸ª: <code>executor_config, mod, params</code>ï¼› å…¶ä¸­ <code>executor_config</code> æ˜¯ä¸€ä¸ª json-like form çš„configï¼Œ ç”¨äºç»™åç»­ç”Ÿæˆç»™ graph_executor æä¾›ä¿¡æ¯ï¼› <code>mod</code> æ˜¯åŒ…å«å„ç§å¿…éœ€è¿è¡Œæ—¶åº“çš„ <code>runtime.module</code>ï¼› <code>params</code> æ˜¯ä¼˜åŒ–åçš„è®¡ç®—å›¾çš„å‚æ•°ã€‚</p>
</li>
<li>
<p><code>BuildModule()</code> å¯¹åº”åœ¨ C++ ä¸­çš„ <code>src/relay/backend/build_module.cc</code> ä¸­:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RelayBuildModule</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">runtime</span><span class="o">::</span><span class="n">ModuleNode</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">protected</span><span class="o">:</span>
<span class="w">  </span><span class="c1">// return The updated Relay IR module after optimization.</span>
<span class="w">  </span><span class="n">IRModule</span><span class="w"> </span><span class="n">Optimize</span><span class="p">(</span><span class="n">IRModule</span><span class="w"> </span><span class="n">relay_module</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">Target</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">raw_targets</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Compile a Relay IR module to runtime module. ç»“æœä¿å­˜åœ¨ `this-&gt;ret_`</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">BuildRelay</span><span class="p">(</span><span class="n">IRModule</span><span class="w"> </span><span class="n">relay_module</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">mod_name</span><span class="p">);</span>

<span class="w"> </span><span class="k">protected</span><span class="o">:</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ExecutorCodegen</span><span class="o">&gt;</span><span class="w"> </span><span class="n">executor_codegen_</span><span class="p">;</span>
<span class="w">  </span><span class="n">Executor</span><span class="w"> </span><span class="n">executor_</span><span class="p">;</span><span class="w">     </span><span class="c1">// Executor to build for</span>
<span class="w">  </span><span class="n">Runtime</span><span class="w"> </span><span class="n">runtime_</span><span class="p">;</span><span class="w">       </span><span class="c1">// Runtime to codegen for</span>
<span class="w">  </span><span class="n">WorkspaceMemoryPools</span><span class="w"> </span><span class="n">workspace_memory_pools_</span><span class="p">;</span>
<span class="w">  </span><span class="n">ConstantMemoryPools</span><span class="w"> </span><span class="n">constant_memory_pools_</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">runtime</span><span class="o">::</span><span class="n">NDArray</span><span class="o">&gt;</span><span class="w"> </span><span class="n">params_</span><span class="p">;</span><span class="w"> </span><span class="c1">// parameters</span>
<span class="w">  </span><span class="n">BuildOutput</span><span class="w"> </span><span class="n">ret_</span><span class="p">;</span><span class="w"> </span><span class="c1">// building output</span>
<span class="w">  </span><span class="n">CompilationConfig</span><span class="w"> </span><span class="n">config_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p><code>bld_mod.build</code> ç›´æ¥å¯¹åº”ä¸Šè¿° <code>Build</code> å‡½æ•°ï¼Œè¯¥å‡½ç®€å•åœ°æŠŠå‡½æ•°å‚æ•°å¦‚ runtimeï¼Œ executorï¼Œ config ç­‰èµ‹å€¼ç»™å¯¹åº”çš„filedsï¼Œ æ¥ç€è°ƒç”¨ä¸Šè¿°ä»£ç ä¸­çš„ <code>BuildRelay</code> å‡½æ•°ï¼Œè¿™æ˜¯æ•´ä¸ª build ä¸­çš„å…³é”®éƒ¨åˆ†</p>
</li>
<li>
<p><code>BuildRelay</code> å‡½æ•°ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">BuildRelay</span><span class="p">(</span><span class="n">IRModule</span><span class="w"> </span><span class="n">relay_module</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">String</span><span class="o">&amp;</span><span class="w"> </span><span class="n">mod_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 1. Relay IRModule -&gt; IRModule ä¼˜åŒ– (TODO: å±•å¼€)</span>
<span class="w">  </span><span class="n">relay_module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OptimizeImpl</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">relay_module</span><span class="p">));</span>

<span class="w">  </span><span class="n">Function</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Downcast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">relay_module</span><span class="o">-&gt;</span><span class="n">Lookup</span><span class="p">(</span><span class="s">&quot;main&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="s">&quot;After `OptimizeImpl`: relay_module-&gt;Lookup(&#39;main&#39;)&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PrettyPrint</span><span class="p">(</span><span class="n">func</span><span class="p">);</span><span class="w"> </span><span class="c1">// my print</span>

<span class="w">  </span><span class="n">IRModule</span><span class="w"> </span><span class="n">func_module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WithAttrs</span><span class="p">(</span><span class="n">IRModule</span><span class="o">::</span><span class="n">FromExpr</span><span class="p">(</span><span class="n">func</span><span class="p">),{</span><span class="cm">/*executor ç­‰ attrs...*/</span><span class="p">});</span>

<span class="w">  </span><span class="c1">// 2. ä¸ºä¼˜åŒ–åçš„å‡½æ•°æ‰§è¡Œ codegen</span>
<span class="w">  </span><span class="c1">// 2.1. å¦‚æœæ˜¯ graph_executor åˆ›å»ºä¸€ä¸ª `GraphCodegen` å¯¹è±¡</span>
<span class="w">  </span><span class="n">executor_codegen_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MakeExecutorCodegen</span><span class="p">(</span><span class="n">executor_</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">  </span><span class="n">executor_codegen_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">(</span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="n">config_</span><span class="o">-&gt;</span><span class="n">primitive_targets</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// è¿™é‡Œçš„codegen å¯¹åº” GraphExecutorCodegen::Codegen</span>
<span class="w">  </span><span class="c1">//  a) è®¾ç½® memory_plan_</span>
<span class="w">  </span><span class="c1">//  b) LowerTE, lower ä¹‹åçš„ IR åœ¨ tir level </span>
<span class="w">  </span><span class="n">executor_codegen_</span><span class="o">-&gt;</span><span class="n">Codegen</span><span class="p">(</span><span class="n">func_module</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">mod_name</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// ä¸º ret_ è®¾ç½® graph_json</span>
<span class="w">  </span><span class="n">executor_codegen_</span><span class="o">-&gt;</span><span class="n">UpdateOutput</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret_</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// ret_ åŒ…æ‹¬: 1) graph_json å­—ç¬¦ä¸²; 2) runtime.mod; 3)[string: NDArray] params å­—å…¸;</span>
<span class="w">  </span><span class="c1">// è¿™é‡Œè®¾ç½® executor_codegen_ åœ¨ codegen é˜¶æ®µæ„é€ çš„ params </span>
<span class="w">  </span><span class="n">ret_</span><span class="p">.</span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor_codegen_</span><span class="o">-&gt;</span><span class="n">GetParams</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// 2.2. æ‹¿åˆ° lowerd_funcs ï¼ˆæ­¤æ—¶Relayå‡½æ•°å·²ç»ä¸‹é™ä¸º PrimFuncï¼‰</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">lowered_funcs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor_codegen_</span><span class="o">-&gt;</span><span class="n">GetIRModule</span><span class="p">();</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">Target</span><span class="o">&amp;</span><span class="w"> </span><span class="n">host_target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config_</span><span class="o">-&gt;</span><span class="n">host_virtual_device</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">runtime</span><span class="o">::</span><span class="n">PackedFunc</span><span class="o">*</span><span class="w"> </span><span class="n">pf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runtime</span><span class="o">::</span><span class="n">Registry</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="s">&quot;codegen.LLVMModuleCreate&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 2.3. å¦‚æœç”±äºä¼˜åŒ–ç­‰åŸå› ï¼Œ lowered_funcs é›†åˆä¸ºç©ºæ—¶ï¼Œè¿”å›ç©º module</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lowered_funcs</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="cm">/* çœç•¥...*/</span><span class="p">}</span><span class="w"> </span>
<span class="w">  </span><span class="c1">// 3. å¦åˆ™æ‰§è¡Œ TIRToRuntimeï¼Œ å¯ä»¥å‚è€ƒ tir ä¸‹é™ä¸€èŠ‚ä¸­çš„æ­¥éª¤</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="n">ret_</span><span class="p">.</span><span class="n">mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tvm</span><span class="o">::</span><span class="n">TIRToRuntime</span><span class="p">(</span><span class="n">lowered_funcs</span><span class="p">,</span><span class="w"> </span><span class="n">host_target</span><span class="p">);}</span>

<span class="w">  </span><span class="c1">// 4. æ¥ä¸‹æ¥æ˜¯å¯¹ external module çš„å¤„ç†</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p><code>BuildRelay</code> åŒ…å«äº† Optimize ï¼Œ Codegen ä¸¤ä¸ªè¿‡ç¨‹ï¼š</p>
<ol>
<li>
<p>åœ¨ <code>Build</code> ä¹‹å‰ï¼š Relay é˜¶æ®µçš„ IRModuleï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nd">@main</span><span class="p">(</span><span class="o">%</span><span class="n">data</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">784</span><span class="p">),</span> <span class="n">float32</span><span class="p">],</span> <span class="o">%</span><span class="n">weight1</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">[(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">784</span><span class="p">),</span> <span class="n">float32</span><span class="p">],</span> <span class="o">%</span><span class="n">bias1</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">[(</span><span class="mi">128</span><span class="p">),</span> <span class="n">float32</span><span class="p">],</span> <span class="o">%</span><span class="n">weight2</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">[(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span> <span class="n">float32</span><span class="p">],</span> <span class="o">%</span><span class="n">bias2</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">[(</span><span class="mi">10</span><span class="p">),</span> <span class="n">float32</span><span class="p">])</span> <span class="p">{</span>
  <span class="o">%</span><span class="mi">0</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="o">%</span><span class="n">data</span><span class="p">,</span> <span class="o">%</span><span class="n">weight1</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">);</span>
  <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">bias_add</span><span class="p">(</span><span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="o">%</span><span class="n">bias1</span><span class="p">);</span>
  <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">);</span>
  <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="o">%</span><span class="n">weight2</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">);</span>
  <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">bias_add</span><span class="p">(</span><span class="o">%</span><span class="mi">3</span><span class="p">,</span> <span class="o">%</span><span class="n">bias2</span><span class="p">);</span>
  <span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="o">%</span><span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>åœ¨ <code>Optmize</code> ä¹‹åï¼Œ äºæ‰“å°å‡ºè¿™æ—¶çš„ IR å‘ç°æ˜¯ä»¥ Tensor ä¸ºæ“ä½œå•ä½ï¼Œå³è½¬ä¸ºäº† TEçš„è¡¨ç¤ºï¼Œå¹¶ä¸”åœ¨TEå±‚çº§è¿›è¡Œäº†ç®—å­èåˆï¼Œå¯ä»¥çœ‹åˆ°ï¼Œåœ¨Relayä¸­çš„ <code>nn.dense</code> Op, ä»¥åŠ <code>nn.bias_add</code> Op, <code>nn.relu</code> Op åœ¨è¿™é‡Œçš„ IR ä¸­éƒ½è¢«è½¬ä¸ºTEè¡¨ç¤ºï¼Œå¹¶ä¸”ä¸‰ä¸ªç®—å­è¢«åŒ…è£¹åˆ°äº†ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œåœ¨æ¥ä¸‹æ¥çš„ codegen ä¸­ï¼Œ ä¸‰ä¸ªTEå‡½æ•°å°†ä¼šè¢«èåˆæˆä¸€ä¸ªè®¡ç®—è¿‡ç¨‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">fn</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="o">%</span><span class="n">data</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">],</span><span class="w"> </span>
<span class="w">  </span><span class="o">%</span><span class="n">weight1</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">],</span><span class="w"> </span>
<span class="w">  </span><span class="o">%</span><span class="n">bias1</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">128</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">],</span><span class="w"> </span>
<span class="w">  </span><span class="o">%</span><span class="n">weight2</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">],</span><span class="w"> </span>
<span class="w">  </span><span class="o">%</span><span class="n">bias2</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">],</span><span class="w"> </span>
<span class="w">  </span><span class="n">dst_layout</span><span class="o">=</span><span class="s">&quot;NC5n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">executor</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="n">Executor</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">runtime</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="n">Runtime</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">hash</span><span class="o">=</span><span class="s">&quot;e88b28184aebb4db&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="n">src_layout</span><span class="o">=</span><span class="s">&quot;NC&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">virtual_device</span><span class="o">=</span><span class="n">VirtualDevice</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">virtual_device_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="o">=</span><span class="n">Target</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="n">d4d3b79920</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span><span class="o">=</span><span class="err">&#39;</span><span class="n">llvm</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">keys</span><span class="o">=</span><span class="p">{</span><span class="err">&#39;</span><span class="n">cpu</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="n">host</span><span class="o">=</span><span class="n">Target</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="n">d4d3b79a00</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span><span class="o">=</span><span class="err">&#39;</span><span class="n">llvm</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">keys</span><span class="o">=</span><span class="p">{</span><span class="err">&#39;</span><span class="n">cpu</span><span class="err">&#39;</span><span class="p">})))</span>
<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="c1">// æ•°æ® layout è½¬æ¢</span>
<span class="w">  </span><span class="o">%</span><span class="mi">6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">p02</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">],</span><span class="n">Primitive</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span><span class="o">=</span><span class="s">&quot;e9662aa5b8e67b96&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">src_layout</span><span class="o">=</span><span class="s">&quot;NC&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dst_layout</span><span class="o">=</span><span class="s">&quot;NC8n&quot;</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">layout_transform</span><span class="p">(</span><span class="o">%</span><span class="n">p02</span><span class="p">,</span><span class="w"> </span><span class="n">src_layout</span><span class="o">=</span><span class="s">&quot;NC&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dst_layout</span><span class="o">=</span><span class="s">&quot;NC8n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span><span class="o">%</span><span class="mi">7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%</span><span class="mi">6</span><span class="p">(</span><span class="o">%</span><span class="n">weight1</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// å¯¹åº” Relay function IR ä¸­çš„</span>
<span class="w">  </span><span class="c1">// %0 = nn.dense(%data, %weight1, units=None);</span>
<span class="w">  </span><span class="c1">// %1 = nn.bias_add(%0, %bias1);</span>
<span class="w">  </span><span class="c1">// %2 = nn.relu(%1);</span>
<span class="w">  </span><span class="o">%</span><span class="mi">8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">p01</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">],</span><span class="w"> </span><span class="o">%</span><span class="n">p11</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">],</span><span class="w"> </span><span class="o">%</span><span class="n">p21</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">128</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">],</span><span class="w"> </span><span class="n">Primitive</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span><span class="o">=</span><span class="s">&quot;f360b4c42be956c4&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">weight_layout</span><span class="o">=</span><span class="s">&quot;NC8n&quot;</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">%</span><span class="mi">3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nn</span><span class="p">.</span><span class="n">contrib_dense_pack</span><span class="p">(</span><span class="o">%</span><span class="n">p01</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">p11</span><span class="p">,</span><span class="w"> </span><span class="n">units</span><span class="o">=</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">out_dtype</span><span class="o">=</span><span class="s">&quot;float32&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">weight_layout</span><span class="o">=</span><span class="s">&quot;NC8n&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="o">%</span><span class="mi">4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expand_dims</span><span class="p">(</span><span class="o">%</span><span class="n">p21</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="o">%</span><span class="mi">5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="o">%</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="mi">4</span><span class="p">);</span>
<span class="w">    </span><span class="n">nn</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="o">%</span><span class="mi">5</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span>

<span class="w">  </span><span class="c1">// æ•°æ® Layout è½¬æ¢</span>
<span class="w">  </span><span class="o">%</span><span class="mi">9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">p03</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">],</span><span class="w"> </span><span class="n">Primitive</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span><span class="o">=</span><span class="s">&quot;86451ec737a6a453&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">src_layout</span><span class="o">=</span><span class="s">&quot;NC&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dst_layout</span><span class="o">=</span><span class="s">&quot;NC5n&quot;</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">layout_transform</span><span class="p">(</span><span class="o">%</span><span class="n">p03</span><span class="p">,</span><span class="w"> </span><span class="n">src_layout</span><span class="o">=</span><span class="s">&quot;NC&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dst_layout</span><span class="o">=</span><span class="s">&quot;NC5n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="cm">/* ty=fn (Tensor[(10, 128), float32]) -&gt; Tensor[(2, 128, 5), float32] */</span><span class="p">;</span>
<span class="w">  </span><span class="o">%</span><span class="mi">10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%</span><span class="mi">8</span><span class="p">(</span><span class="o">%</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">bias1</span><span class="p">);</span>
<span class="w">  </span><span class="o">%</span><span class="mi">11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%</span><span class="mi">9</span><span class="p">(</span><span class="o">%</span><span class="n">weight2</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// å¯¹åº” Relay function IR ä¸­çš„</span>
<span class="w">  </span><span class="c1">// %3 = nn.dense(%2, %weight2, units=None);</span>
<span class="w">  </span><span class="c1">// %4 = nn.bias_add(%3, %bias2);</span>
<span class="w">  </span><span class="c1">// nn.relu(%4)</span>
<span class="w">  </span><span class="o">%</span><span class="mi">12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">p0</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">],</span><span class="w"> </span><span class="o">%</span><span class="n">p1</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">],</span><span class="w"> </span><span class="o">%</span><span class="n">p2</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">],</span><span class="w"> </span><span class="n">Primitive</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span><span class="o">=</span><span class="s">&quot;32a532a5919d3a8b&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">weight_layout</span><span class="o">=</span><span class="s">&quot;NC5n&quot;</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">%</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nn</span><span class="p">.</span><span class="n">contrib_dense_pack</span><span class="p">(</span><span class="o">%</span><span class="n">p0</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">units</span><span class="o">=</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">out_dtype</span><span class="o">=</span><span class="s">&quot;float32&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">weight_layout</span><span class="o">=</span><span class="s">&quot;NC5n&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="o">%</span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expand_dims</span><span class="p">(</span><span class="o">%</span><span class="n">p2</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="o">%</span><span class="mi">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="o">%</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">nn</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span>
<span class="w">  </span><span class="o">%</span><span class="mi">12</span><span class="p">(</span><span class="o">%</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">bias2</span><span class="p">)</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div>
</li>
<li>
<p>æ¥ç€æ˜¯ <code>CodeGen</code> (<code>GraphExecutorCodegen</code> çš„æ–¹æ³•)ä¸­å¯¹ TE çš„ lowerï¼Œ å¯¹åº”åˆ° <code>tec::LowerTE</code> å‡½æ•°çš„è°ƒç”¨:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// In GraphExecutorCodegen:</span>
<span class="c1">// relay::backend::LoweredOutput Codegen(tvm::IRModule mod, relay::Function func,tvm::runtime::String mod_name)</span>

<span class="p">...</span>

<span class="n">IRModule</span><span class="w"> </span><span class="n">lowered_mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tec</span><span class="o">::</span><span class="n">LowerTE</span><span class="p">(</span><span class="n">mod_name_</span><span class="p">,</span><span class="w"> </span><span class="n">config_</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="n">BaseFunc</span><span class="w"> </span><span class="n">func</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">GetAttr</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="n">attr</span><span class="o">::</span><span class="n">kCompiler</span><span class="p">).</span><span class="n">defined</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">UpdateConstants</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">params_</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">tec</span><span class="o">::</span><span class="n">UpdateFunctionMetadata</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">function_metadata_</span><span class="p">);</span>
<span class="p">})(</span><span class="n">mod</span><span class="p">);</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;after complile TE:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PrettyPrint</span><span class="p">(</span><span class="n">lowered_mod</span><span class="p">);</span><span class="w"> </span><span class="c1">// dmhj</span>

<span class="p">...</span>
</code></pre></div>
<p>TE è¢« lower ä¹‹åçš„ IR ç”± tir Stmt ç»„æˆï¼Œ TE å‡½æ•°è¢«è½¬æ¢æˆ PrimFunc(å…ƒå¼ é‡å‡½æ•°)ï¼Œ åœ¨ ä¸‹é¢çš„ IR ä¸­ å¯ä»¥çœ‹åˆ°å‡ºç°äº† <code>Pointer</code>, <code>Buffer</code>, <code>AllocateNode</code> ç­‰ Stmt èŠ‚ç‚¹ï¼Œè¿™æ˜¯åœ¨ TE å’Œ Relay å±‚çº§ä¸ä¼šå‡ºç°çš„æŠ½è±¡</p>
<div class="highlight"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="err">@</span><span class="n">main</span><span class="p">(</span>
<span class="w">  </span><span class="o">%</span><span class="n">data</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">%</span><span class="n">weight1</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">%</span><span class="n">bias1</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">128</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">%</span><span class="n">weight2</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">%</span><span class="n">bias2</span><span class="o">:</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span>

<span class="w">  </span><span class="n">dst_layout</span><span class="o">=</span><span class="s">&quot;NC5n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">executor</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="n">Executor</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">runtime</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="n">Runtime</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">hash</span><span class="o">=</span><span class="s">&quot;e88b28184aebb4db&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">src_layout</span><span class="o">=</span><span class="s">&quot;NC&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="n">virtual_device</span><span class="o">=</span><span class="n">VirtualDevice</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">virtual_device_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="o">=</span><span class="n">Target</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="n">d233c937a0</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span><span class="o">=</span><span class="err">&#39;</span><span class="n">llvm</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">keys</span><span class="o">=</span><span class="p">{</span><span class="err">&#39;</span><span class="n">cpu</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="n">host</span><span class="o">=</span><span class="n">Target</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="n">d233c94220</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span><span class="o">=</span><span class="err">&#39;</span><span class="n">llvm</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">keys</span><span class="o">=</span><span class="p">{</span><span class="err">&#39;</span><span class="n">cpu</span><span class="err">&#39;</span><span class="p">})))</span>
<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Tensor</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="o">%</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">weight1</span><span class="p">,)</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="o">%</span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call_lowered</span><span class="p">(</span><span class="err">@</span><span class="n">tvmgen_default_fused_layout_transform</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;relay_attrs&quot;</span><span class="o">=</span><span class="p">{</span><span class="n">__dict__</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;Primitive&quot;</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hash&quot;</span><span class="o">=</span><span class="s">&quot;e9662aa5b8e67b96&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;src_layout&quot;</span><span class="o">=</span><span class="s">&quot;NC&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;dst_layout&quot;</span><span class="o">=</span><span class="s">&quot;NC8n&quot;</span><span class="p">}},</span><span class="w"> </span><span class="s">&quot;all_prim_fn_vars&quot;</span><span class="o">=</span><span class="p">[</span><span class="err">&#39;</span><span class="n">tvmgen_default_fused_layout_transform</span><span class="err">&#39;</span><span class="p">]})</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="o">%</span><span class="mi">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">bias1</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="o">%</span><span class="mi">3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">weight2</span><span class="p">,)</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="o">%</span><span class="mi">4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call_lowered</span><span class="p">(</span><span class="err">@</span><span class="n">tvmgen_default_fused_nn_contrib_dense_pack_expand_dims_add_nn_relu</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;relay_attrs&quot;</span><span class="o">=</span><span class="p">{</span><span class="n">__dict__</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;Primitive&quot;</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hash&quot;</span><span class="o">=</span><span class="s">&quot;f360b4c42be956c4&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;weight_layout&quot;</span><span class="o">=</span><span class="s">&quot;NC8n&quot;</span><span class="p">}},</span><span class="w"> </span><span class="s">&quot;all_prim_fn_vars&quot;</span><span class="o">=</span><span class="p">[</span><span class="err">&#39;</span><span class="n">tvmgen_default_fused_nn_contrib_dense_pack_expand_dims_add_nn_relu</span><span class="err">&#39;</span><span class="p">]})</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="o">%</span><span class="mi">5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call_lowered</span><span class="p">(</span><span class="err">@</span><span class="n">tvmgen_default_fused_layout_transform_1</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;relay_attrs&quot;</span><span class="o">=</span><span class="p">{</span><span class="n">__dict__</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;Primitive&quot;</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hash&quot;</span><span class="o">=</span><span class="s">&quot;86451ec737a6a453&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;src_layout&quot;</span><span class="o">=</span><span class="s">&quot;NC&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;dst_layout&quot;</span><span class="o">=</span><span class="s">&quot;NC5n&quot;</span><span class="p">}},</span><span class="w"> </span><span class="s">&quot;all_prim_fn_vars&quot;</span><span class="o">=</span><span class="p">[</span><span class="err">&#39;</span><span class="n">tvmgen_default_fused_layout_transform_1</span><span class="err">&#39;</span><span class="p">]})</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="o">%</span><span class="mi">6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">bias2</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="n">call_lowered</span><span class="p">(</span><span class="err">@</span><span class="n">tvmgen_default_fused_nn_contrib_dense_pack_expand_dims_add_nn_relu_1</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;relay_attrs&quot;</span><span class="o">=</span><span class="p">{</span><span class="n">__dict__</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;Primitive&quot;</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hash&quot;</span><span class="o">=</span><span class="s">&quot;32a532a5919d3a8b&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;weight_layout&quot;</span><span class="o">=</span><span class="s">&quot;NC5n&quot;</span><span class="p">}},</span><span class="w"> </span><span class="s">&quot;all_prim_fn_vars&quot;</span><span class="o">=</span><span class="p">[</span><span class="err">&#39;</span><span class="n">tvmgen_default_fused_nn_contrib_dense_pack_expand_dims_add_nn_relu_1</span><span class="err">&#39;</span><span class="p">]})</span><span class="w"> </span>
<span class="p">}</span>

<span class="err">@</span><span class="n">tvmgen_default_fused_layout_transform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">primfn</span><span class="p">(</span><span class="n">p0_1</span><span class="o">:</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">T_layout_trans_1</span><span class="o">:</span><span class="w"> </span><span class="n">handle</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="n">buffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nl">p0</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p0_2</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">float32</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">],</span><span class="w"> </span><span class="p">[]),</span>
<span class="w">    </span><span class="nl">T_layout_trans</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">T_layout_trans_2</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">float32</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="p">[])</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">buffer_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">p0_1</span><span class="o">:</span><span class="w"> </span><span class="n">p0</span><span class="p">,</span><span class="w"> </span><span class="n">T_layout_trans_1</span><span class="o">:</span><span class="w"> </span><span class="n">T_layout_trans</span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ax0</span><span class="p">.</span><span class="n">ax1</span><span class="p">.</span><span class="n">fused</span><span class="o">:</span><span class="w"> </span><span class="n">int32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">12544</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;parallel&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nl">T_layout_trans_3</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">T_layout_trans_2</span><span class="p">,</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">100352</span><span class="p">],</span><span class="w"> </span><span class="p">[])[</span><span class="n">ramp</span><span class="p">((</span><span class="n">ax0</span><span class="p">.</span><span class="n">ax1</span><span class="p">.</span><span class="n">fused</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">      </span><span class="nl">p0_3</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p0_2</span><span class="p">,</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">100352</span><span class="p">],</span><span class="w"> </span><span class="p">[])[</span>
<span class="w">        </span><span class="n">ramp</span><span class="p">(((</span><span class="n">floordiv</span><span class="p">(</span><span class="n">ax0</span><span class="p">.</span><span class="n">ax1</span><span class="p">.</span><span class="n">fused</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">)</span><span class="o">*</span><span class="mi">6272</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">floormod</span><span class="p">(</span><span class="n">ax0</span><span class="p">.</span><span class="n">ax1</span><span class="p">.</span><span class="n">fused</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">)),</span><span class="w"> </span><span class="mi">784</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="err">@</span><span class="n">tvmgen_default_fused_layout_transform_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">primfn</span><span class="p">(</span><span class="n">p0_5</span><span class="o">:</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">T_layout_trans_5</span><span class="o">:</span><span class="w"> </span><span class="n">handle</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="n">buffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nl">p0_4</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p0_6</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">float32</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">],</span><span class="w"> </span><span class="p">[]),</span>
<span class="w">    </span><span class="nl">T_layout_trans_4</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">T_layout_trans_6</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">float32</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="p">[])</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">buffer_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">p0_5</span><span class="o">:</span><span class="w"> </span><span class="n">p0_4</span><span class="p">,</span><span class="w"> </span><span class="n">T_layout_trans_5</span><span class="o">:</span><span class="w"> </span><span class="n">T_layout_trans_4</span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ax0</span><span class="p">.</span><span class="n">ax1</span><span class="p">.</span><span class="n">fused_1</span><span class="o">:</span><span class="w"> </span><span class="n">int32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;parallel&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nl">T_layout_trans_7</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">T_layout_trans_6</span><span class="p">,</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1280</span><span class="p">],</span><span class="w"> </span><span class="p">[])[</span><span class="n">ramp</span><span class="p">((</span><span class="n">ax0</span><span class="p">.</span><span class="n">ax1</span><span class="p">.</span><span class="n">fused_1</span><span class="o">*</span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">      </span><span class="nl">p0_7</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p0_6</span><span class="p">,</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1280</span><span class="p">],</span><span class="w"> </span><span class="p">[])[</span>
<span class="w">        </span><span class="n">ramp</span><span class="p">(((</span><span class="n">floordiv</span><span class="p">(</span><span class="n">ax0</span><span class="p">.</span><span class="n">ax1</span><span class="p">.</span><span class="n">fused_1</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span><span class="o">*</span><span class="mi">640</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">floormod</span><span class="p">(</span><span class="n">ax0</span><span class="p">.</span><span class="n">ax1</span><span class="p">.</span><span class="n">fused_1</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">)),</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="err">@</span><span class="n">tvmgen_default_fused_nn_contrib_dense_pack_expand_dims_add_nn_relu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">primfn</span><span class="p">(</span><span class="n">p0_9</span><span class="o">:</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">p1_1</span><span class="o">:</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">p2_1</span><span class="o">:</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">T_relu_1</span><span class="o">:</span><span class="w"> </span><span class="n">handle</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="n">attr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;from_legacy_te_schedule&quot;</span><span class="o">:</span><span class="w"> </span><span class="n">True</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;target&quot;</span><span class="o">:</span><span class="w"> </span><span class="n">Target</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="n">d233c937a0</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span><span class="o">=</span><span class="err">&#39;</span><span class="n">llvm</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">keys</span><span class="o">=</span><span class="p">{</span><span class="err">&#39;</span><span class="n">cpu</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="n">host</span><span class="o">=</span><span class="n">Target</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="n">d233c94220</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span><span class="o">=</span><span class="err">&#39;</span><span class="n">llvm</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">keys</span><span class="o">=</span><span class="p">{</span><span class="err">&#39;</span><span class="n">cpu</span><span class="err">&#39;</span><span class="p">})),</span><span class="w"> </span><span class="s">&quot;tir.noalias&quot;</span><span class="o">:</span><span class="w"> </span><span class="n">True</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hash&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;f360b4c42be956c4&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;global_symbol&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;tvmgen_default_fused_nn_contrib_dense_pack_expand_dims_add_nn_relu&quot;</span><span class="p">}</span>
<span class="w">  </span><span class="n">buffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nl">p0_8</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p0_10</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">float32</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">],</span><span class="w"> </span><span class="p">[]),</span>
<span class="w">    </span><span class="nl">p1</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p1_2</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">float32</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="p">[]),</span>
<span class="w">    </span><span class="nl">p2</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p2_2</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">float32</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">128</span><span class="p">],</span><span class="w"> </span><span class="p">[]),</span>
<span class="w">    </span><span class="nl">T_relu</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">T_relu_2</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">float32</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">],</span><span class="w"> </span><span class="p">[])</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">buffer_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">p0_9</span><span class="o">:</span><span class="w"> </span><span class="n">p0_8</span><span class="p">,</span><span class="w"> </span><span class="n">p1_1</span><span class="o">:</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2_1</span><span class="o">:</span><span class="w"> </span><span class="n">p2</span><span class="p">,</span><span class="w"> </span><span class="n">T_relu_1</span><span class="o">:</span><span class="w"> </span><span class="n">T_relu</span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ax1</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">ax0</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">fused</span><span class="o">:</span><span class="w"> </span><span class="n">int32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;parallel&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">allocate</span><span class="p">(</span><span class="n">compute</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="n">float32x8</span><span class="p">),</span><span class="w"> </span><span class="n">float32x8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span><span class="w"> </span><span class="n">storage_scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global</span><span class="p">;</span>
<span class="w">    </span><span class="n">allocate</span><span class="p">(</span><span class="n">compute</span><span class="p">.</span><span class="n">global</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="n">float32x8</span><span class="p">),</span><span class="w"> </span><span class="n">float32x8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">storage_scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">fused</span><span class="o">:</span><span class="w"> </span><span class="n">int32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">compute</span><span class="p">.</span><span class="n">global_1</span><span class="o">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">compute</span><span class="p">.</span><span class="n">global</span><span class="p">,</span><span class="w"> </span><span class="n">float32x8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="n">align</span><span class="o">=</span><span class="mi">32</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">broadcast</span><span class="p">(</span><span class="mf">0f</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">outer</span><span class="o">:</span><span class="w"> </span><span class="n">int32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">784</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">compute</span><span class="p">.</span><span class="n">global_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">compute</span><span class="p">.</span><span class="n">global_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">broadcast</span><span class="p">(</span><span class="n">p0_11</span><span class="o">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p0_10</span><span class="p">,</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">784</span><span class="p">],</span><span class="w"> </span><span class="p">[])[</span><span class="n">k</span><span class="p">.</span><span class="n">outer</span><span class="p">],</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="n">p1_3</span><span class="o">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p1_2</span><span class="p">,</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">100352</span><span class="p">],</span><span class="w"> </span><span class="p">[])[</span><span class="n">ramp</span><span class="p">((((</span><span class="n">ax1</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">ax0</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">fused</span><span class="o">*</span><span class="mi">25088</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">fused</span><span class="o">*</span><span class="mi">6272</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">outer</span><span class="o">*</span><span class="mi">8</span><span class="p">)),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)]))</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nl">compute_1</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">compute</span><span class="p">,</span><span class="w"> </span><span class="n">float32x8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="p">[])[</span><span class="n">y</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">fused</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute</span><span class="p">.</span><span class="n">global_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ax1</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">outer</span><span class="o">:</span><span class="w"> </span><span class="n">int32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">let</span><span class="w"> </span><span class="n">cse_var_1</span><span class="o">:</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">ax1</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">ax0</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">fused</span><span class="o">*</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">ax1</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">outer</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span>
<span class="w">        </span><span class="nl">T_relu_3</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">T_relu_2</span><span class="p">,</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">128</span><span class="p">],</span><span class="w"> </span><span class="p">[])[</span><span class="n">ramp</span><span class="p">(</span><span class="n">cse_var_1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">((</span><span class="n">compute_1</span><span class="p">[</span><span class="n">ax1</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">outer</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p2_3</span><span class="o">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p2_2</span><span class="p">,</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">128</span><span class="p">],</span><span class="w"> </span><span class="p">[])[</span><span class="n">ramp</span><span class="p">(</span><span class="n">cse_var_1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)]),</span><span class="w"> </span><span class="n">broadcast</span><span class="p">(</span><span class="mf">0f</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="err">@</span><span class="n">tvmgen_default_fused_nn_contrib_dense_pack_expand_dims_add_nn_relu_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">primfn</span><span class="p">(</span>
<span class="w">  </span><span class="nl">p0_13</span><span class="p">:</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">p1_5</span><span class="o">:</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">p2_5</span><span class="o">:</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">T_relu_5</span><span class="o">:</span><span class="w"> </span><span class="n">handle</span>
<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="n">buffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nl">p0_12</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p0_14</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">float32</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">],</span><span class="w"> </span><span class="p">[]),</span>
<span class="w">    </span><span class="nl">p1_4</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p1_6</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">float32</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="p">[]),</span>
<span class="w">    </span><span class="nl">p2_4</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p2_6</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">float32</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="w"> </span><span class="p">[]),</span>
<span class="w">    </span><span class="nl">T_relu_4</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">T_relu_6</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">float32</span><span class="p">),</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">],</span><span class="w"> </span><span class="p">[])</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">buffer_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">p0_13</span><span class="o">:</span><span class="w"> </span><span class="n">p0_12</span><span class="p">,</span><span class="w"> </span><span class="n">p1_5</span><span class="o">:</span><span class="w"> </span><span class="n">p1_4</span><span class="p">,</span><span class="w"> </span><span class="n">p2_5</span><span class="o">:</span><span class="w"> </span><span class="n">p2_4</span><span class="p">,</span><span class="w"> </span><span class="n">T_relu_5</span><span class="o">:</span><span class="w"> </span><span class="n">T_relu_4</span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ax1</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">ax0</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">fused_1</span><span class="o">:</span><span class="w"> </span><span class="n">int32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;parallel&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">let</span><span class="w"> </span><span class="n">cse_var_1_1</span><span class="o">:</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ax1</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">ax0</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">fused_1</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
<span class="w">    </span><span class="n">allocate</span><span class="p">(</span><span class="n">compute</span><span class="p">.</span><span class="n">global_2</span><span class="o">:</span><span class="w"> </span><span class="n">Pointer</span><span class="p">(</span><span class="n">global</span><span class="w"> </span><span class="n">float32x5</span><span class="p">),</span><span class="w"> </span><span class="n">float32x5</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">storage_scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">compute</span><span class="p">.</span><span class="n">global_3</span><span class="o">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">compute</span><span class="p">.</span><span class="n">global_2</span><span class="p">,</span><span class="w"> </span><span class="n">float32x5</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="n">align</span><span class="o">=</span><span class="mi">16</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">broadcast</span><span class="p">(</span><span class="mf">0f</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">outer_1</span><span class="o">:</span><span class="w"> </span><span class="n">int32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">compute</span><span class="p">.</span><span class="n">global_3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">compute</span><span class="p">.</span><span class="n">global_3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">broadcast</span><span class="p">(</span><span class="n">p0_15</span><span class="o">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p0_14</span><span class="p">,</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">128</span><span class="p">],</span><span class="w"> </span><span class="p">[])[</span><span class="n">k</span><span class="p">.</span><span class="n">outer_1</span><span class="p">],</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">p1_7</span><span class="o">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p1_6</span><span class="p">,</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1280</span><span class="p">],</span><span class="w"> </span><span class="p">[])[</span><span class="n">ramp</span><span class="p">(((</span><span class="n">ax1</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">ax0</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">fused_1</span><span class="o">*</span><span class="mi">640</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">outer_1</span><span class="o">*</span><span class="mi">5</span><span class="p">)),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)]))</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nl">T_relu_7</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">T_relu_6</span><span class="p">,</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="w"> </span><span class="p">[])[</span><span class="n">ramp</span><span class="p">(</span><span class="n">cse_var_1_1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">((</span><span class="n">compute</span><span class="p">.</span><span class="n">global_4</span><span class="o">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">compute</span><span class="p">.</span><span class="n">global_2</span><span class="p">,</span><span class="w"> </span><span class="n">float32x5</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="n">align</span><span class="o">=</span><span class="mi">16</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p2_7</span><span class="o">:</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">p2_6</span><span class="p">,</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="w"> </span><span class="p">[])[</span><span class="n">ramp</span><span class="p">(</span><span class="n">cse_var_1_1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)]),</span><span class="w"> </span><span class="n">broadcast</span><span class="p">(</span><span class="mf">0f</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>å›¾ä¸­ çš„ IR çœç•¥äº† attributes ä»¥åŠ shape ä¿¡æ¯ç­‰</p>
</li>
<li>
<p>æ¥ä¸‹æ¥é€šè¿‡ Visitor çš„æ–¹å¼DFSéå†åˆšæ‰å¾—åˆ°çš„ IR ï¼Œ å°† IR ä¸­çš„ CallNode, VarNode å’Œ ConstantNode ç­‰æŒ‰ç…§ç›¸åº”çš„è§„åˆ™è½¬æ¢æˆå¯¹åº”çš„ GraphNode; <strong>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ Relay GraphExecutor æ˜¯ä¸æ”¯æŒæ§åˆ¶æµçš„ï¼Œå› æ­¤å¦‚æœ Relay IR ä¸­å«æœ‰ If, Match ç­‰ï¼Œ åœ¨è¿™é‡Œä¼šæ„å»ºå¤±è´¥</strong>ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">GraphNodeRef</span><span class="o">&gt;</span><span class="w"> </span><span class="n">VisitExpr_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VarNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Expr</span><span class="w"> </span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetRef</span><span class="o">&lt;</span><span class="n">Expr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">var_map_</span><span class="p">[</span><span class="n">expr</span><span class="p">.</span><span class="n">get</span><span class="p">()];</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">GraphNodeRef</span><span class="o">&gt;</span><span class="w"> </span><span class="n">VisitExpr_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">IfNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Graph executor does not support control flow (found IfNode)&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">GraphNodeRef</span><span class="o">&gt;</span><span class="w"> </span><span class="n">VisitExpr_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ConstructorNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Graph executor does not support ADTs (found ConstructorNode)&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">GraphNodeRef</span><span class="o">&gt;</span><span class="w"> </span><span class="n">VisitExpr_</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">GlobalVarNode</span><span class="o">*</span><span class="w"> </span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;All GlobalVarNodes should be removed before graph executor&#39;s Codegen is called&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>æ¥ä¸‹æ¥ï¼Œ GraphNode ä¼šè¢«ç»„ç»‡åœ¨ <code>GraphExecutorCodegen</code> çš„ <code>std::vector&lt;GraphObjectPtr&gt; nodes_</code> ä¸­ã€‚ è¿™ä¸ªå›¾æœ€ç»ˆè¢«å†™å…¥ graph_json ä¸­:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;nodes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;op&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;null&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;op&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;null&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;weight1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;op&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;null&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bias1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;op&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;null&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;weight2&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;op&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;null&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bias2&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;op&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tvm_op&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tvmgen_default_fused_layout_transform&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;attrs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;hash&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;e9662aa5b8e67b96&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;num_inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;src_layout&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;NC&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;dst_layout&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;NC8n&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;func_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tvmgen_default_fused_layout_transform&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;flatten_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;num_outputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;op&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tvm_op&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tvmgen_default_fused_nn_contrib_dense_pack_expand_dims_add_nn_relu&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;attrs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;hash&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;f360b4c42be956c4&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;num_inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;weight_layout&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;NC8n&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;func_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tvmgen_default_fused_nn_contrib_dense_pack_expand_dims_add_nn_relu&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;flatten_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;num_outputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;op&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tvm_op&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tvmgen_default_fused_layout_transform_1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;attrs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;hash&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;86451ec737a6a453&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;num_inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;src_layout&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;NC&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;dst_layout&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;NC5n&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;func_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tvmgen_default_fused_layout_transform_1&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;flatten_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;num_outputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;op&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tvm_op&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tvmgen_default_fused_nn_contrib_dense_pack_expand_dims_add_nn_relu_1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;attrs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;hash&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;32a532a5919d3a8b&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;num_inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;weight_layout&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;NC5n&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;func_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tvmgen_default_fused_nn_contrib_dense_pack_expand_dims_add_nn_relu_1&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;flatten_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;num_outputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;inputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;arg_nodes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;heads&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;attrs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;storage_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;list_int&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;shape&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;list_shape&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="p">[</span>
<span class="w">        </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">784</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="mi">784</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">128</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">128</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">784</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">28</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;device_index&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;list_int&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;dltype&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;list_str&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="p">[</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span><span class="s2">&quot;float32&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;node_row_ptr&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ol>
</li>
<li>
<p>æœ€ç»ˆ <code>executor_factory = _executor_factory.GraphExecutorFactoryModule()</code> ä¼šå°†</p>
<ol>
<li>è¾“å…¥çš„ Relay IR</li>
<li>jsonè¡¨ç¤ºçš„ è®¡ç®—æ‰§è¡Œå›¾</li>
<li>å¯¹åº”çš„æ‰§è¡Œå™¨</li>
<li>TIRToRuntime build å‡ºçš„ runtime.module</li>
<li>ä»£ç ç”Ÿæˆçš„ target</li>
<li>ä¼˜åŒ–åçš„è®¡ç®—å›¾çš„è¾“å…¥å‚æ•°</li>
<li>mod_name, func_metadata </li>
</ol>
<p>æ‰“åŒ…æˆä¸€ä¸ªmoduleï¼Œ å¯ä»¥æ ¹æ®è¯¥moduleä¸­çš„ä¿¡æ¯æ„å»ºä¸€ä¸ª graph_executorï¼Œ å¹¶ åˆ©ç”¨ graph_executor åŠ è½½æ‰§è¡Œ graph</p>
</li>
</ol>
<p>ğŸ’¡<u><strong>æ€»ç»“ä¸€ä¸‹</strong></u>: </p>
<ol>
<li>
<p>c++ ç«¯çš„ <code>BuildRelay</code> å‡½æ•°æ˜¯é€šç”¨æ¥å£ <code>relay.build</code> çš„æ ¸å¿ƒï¼Œ åœ¨ä¸Šé¢è¿‡ç¨‹ä¸­ï¼Œ æˆ‘ä»¬æ‰“å‡ºäº† Relay, TE, TIR, graph_json ç­‰å‡ ç§ä¸åŒçš„ä¸­é—´è¡¨ç¤ºï¼Œ ä» Relay åˆ° TEï¼Œ ä»TE åˆ° TIRï¼Œ å†ä» TIR ä¸­çš„å…ƒå¼ é‡å‡½æ•°è¢«ç¿»è¯‘æˆæœºå™¨ç ï¼Œ æ¯ä¸€æ­¥éƒ½ä¼šæ‰§è¡Œç›¸åº”éƒ¨åˆ†çš„ä¼˜åŒ–ã€‚ è‡³äºå…·ä½“åšäº†å“ªäº›ä¼˜åŒ–ï¼Œ TODO:</p>
</li>
<li>
<p>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯é€šè¿‡è¿™æ¡è·¯å¾„ï¼Œæˆ‘ä»¬åªèƒ½ç¼–è¯‘ é™æ€æ¨¡å‹ï¼Œ æ— è®ºæ˜¯æ§åˆ¶æµè¿˜æ˜¯ åŠ¨æ€ shapeï¼Œ æ”¯æŒçš„éƒ½ä¸æ˜¯å¾ˆå¥½ï¼› Relay çš„åç»­å·¥ä½œ nimble åœ¨è¿™ä¸€æ–¹é¢åšå‡ºäº†æ”¹è¿›ï¼Œå¯ä»¥å‚è€ƒ: <a href="paper-nimble.html">nimble</a>ã€‚ ç®€å•æ¥è®²ï¼Œæˆ‘ä»¬ä¸å†ä¾èµ–è¿™ä¸ªç®€å•åœ° graph_executor, è€Œæ˜¯æ„å»ºäº†ä¸€ä¸ªè™šæ‹Ÿæœºè¿›è¡Œè¿è¡Œæ—¶çš„åˆ†æã€å†…å­˜åˆ†é…ã€ç®—å­æ´¾å‘ç­‰ï¼Œåœ¨ Relax ä¸­ä¹Ÿæ˜¯è¿™æ ·åšçš„ï¼Œå› æ­¤æ¥ä¸‹æ¥çš„ä¸€èŠ‚ä»¥ Relax ä¸ºä¾‹ï¼Œ çœ‹ä¸€ä¸‹ TVM å¦‚ä½•æ”¯æŒåŠ¨æ€shapeï¼Œ åŠ¨æ€æ§åˆ¶æµï¼Œ å¦‚ä½•ä½¿ç”¨ VM è¿›è¡Œç›¸åº”æ”¯æŒã€‚</p>
</li>
</ol>
<h2 id="4-lower-relax">4. Lower Relax</h2>
<p><code>gen_call_tir_inputs</code> ä¸­ <code>_convert_te_arg</code> æ³¨é‡Šï¼š</p>
<blockquote>
<p>åœ¨åŠ¨æ€å½¢çŠ¶çš„æƒ…å†µä¸‹ï¼Œä¼ å…¥çš„å‚æ•°å¯èƒ½åŒ…å« TIR å˜é‡ã€‚ ä¾‹å¦‚ï¼Œå‚æ•°å¯ä»¥æ˜¯å…·æœ‰ç¬¦å·å½¢çŠ¶çš„ TensorStructInfo çš„ Relax Varï¼Œæˆ–è€…å‚æ•°å¯ä»¥æ˜¯å…·æœ‰ç¬¦å·å˜é‡çš„ ShapeExprã€‚ ä¸ºäº†ä½¿ç”Ÿæˆçš„ PrimFunc ä¸è°ƒç”¨è€… Relax å‡½æ•°å…·æœ‰è‡ªå˜é‡ï¼Œæˆ‘ä»¬å°†ç”¨æ–°çš„å˜é‡æ›¿æ¢è¾“å…¥å‚æ•°ä¸­çš„ TIR å˜é‡ï¼Œè¿™æ˜¯é€šè¿‡ç»´æŠ¤ TIR å˜é‡æ˜ å°„æ¥å®Œæˆçš„ã€‚</p>
</blockquote>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "navigation.indexes"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fac441b0.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>